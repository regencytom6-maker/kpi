{% extends 'base.html' %}

{% block title %}Store Manager Dashboard - Kampala Pharmaceutical Industries{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="text-primary mb-0">
                        <i class="fas fa-warehouse me-2"></i>Store Manager Dashboard
                    </h2>
                    <p class="text-muted mb-0">Raw Material Release Management</p>
                </div>
                <div class="text-end">
                    <small class="text-muted">Welcome, {{ user.get_full_name|default:user.username }}</small><br>
                    <small class="text-success">{{ user.get_role_display }}</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title mb-0">{{ stats.pending_phases }}</h5>
                            <p class="card-text">Pending Releases</p>
                        </div>
                        <i class="fas fa-clock fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title mb-0">{{ stats.in_progress_phases }}</h5>
                            <p class="card-text">In Progress</p>
                        </div>
                        <i class="fas fa-box fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title mb-0">{{ stats.completed_today }}</h5>
                            <p class="card-text">Completed Today</p>
                        </div>
                        <i class="fas fa-check-circle fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title mb-0">{{ stats.total_batches }}</h5>
                            <p class="card-text">Total Batches</p>
                        </div>
                        <i class="fas fa-clipboard-check fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Raw Material Release Queue -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-warehouse me-2"></i>Raw Material Release Queue
                    </h5>
                </div>
                <div class="card-body">
                    {% if my_phases %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>BMR Number</th>
                                        <th>Product</th>
                                        <th>Batch Size</th>
                                        <th>Priority</th>
                                        <th>Created</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for phase in my_phases %}
                                    <tr>
                                        <td><strong class="text-primary">{{ phase.bmr.bmr_number }}</strong></td>
                                        <td>{{ phase.bmr.product.product_name }}</td>
                                        <td>{{ phase.bmr.batch_size|floatformat:0 }} {{ phase.bmr.product.unit_of_measure }}</td>
                                        <td>
                                            {% if phase.bmr.created_date|timesince|slice:":1" == "0" %}
                                                <span class="badge bg-danger">Urgent</span>
                                            {% elif phase.bmr.created_date|timesince|slice:":1" == "1" %}
                                                <span class="badge bg-warning">High</span>
                                            {% else %}
                                                <span class="badge bg-success">Normal</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ phase.bmr.created_date|date:"M d, H:i" }}</td>
                                        <td>
                                            {% if phase.status == 'pending' %}
                                                <span class="badge bg-warning">Pending</span>
                                            {% elif phase.status == 'in_progress' %}
                                                <span class="badge bg-info">In Progress</span>
                                            {% else %}
                                                <span class="badge bg-success">{{ phase.status|title }}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <a href="{% url 'bmr:detail' phase.bmr.pk %}" 
                                                   class="btn btn-outline-primary btn-sm">
                                                    <i class="fas fa-eye"></i> View
                                                </a>
                                                {% if phase.status == 'pending' %}
                                                <button class="btn btn-outline-success btn-sm"
                                                        onclick="startRelease('{{ phase.bmr.pk }}', '{{ phase.bmr.bmr_number }}')">
                                                    <i class="fas fa-play"></i> Start
                                                </button>
                                                {% elif phase.status == 'in_progress' %}
                                                <button class="btn btn-outline-warning btn-sm"
                                                        onclick="completeRelease('{{ phase.bmr.pk }}', '{{ phase.bmr.bmr_number }}')">
                                                    <i class="fas fa-check"></i> Complete
                                                </button>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-warehouse fa-3x text-success mb-3"></i>
                            <h5 class="text-muted">No Pending Raw Material Releases</h5>
                            <p class="text-muted">All raw material release requests are up to date.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Raw Materials Inventory Status -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-boxes me-2"></i>Raw Materials Inventory Status
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <div class="card border-primary h-100">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0">Inventory Summary</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row text-center">
                                        <div class="col-6 mb-3">
                                            <h4 class="text-primary">{{ stats.total_materials }}</h4>
                                            <small class="text-muted">Total Materials</small>
                                        </div>
                                        <div class="col-6 mb-3">
                                            <h4 class="text-info">{{ stats.total_batches }}</h4>
                                            <small class="text-muted">Total Batches</small>
                                        </div>
                                        <div class="col-6">
                                            <h4 class="text-warning">{{ stats.pending_qc }}</h4>
                                            <small class="text-muted">Pending QC</small>
                                        </div>
                                        <div class="col-6">
                                            <h4 class="text-danger">{{ expiring_soon|length }}</h4>
                                            <small class="text-muted">Expiring Soon</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-9 mb-3">
                            <div class="card border-warning h-100">
                                <div class="card-header bg-warning text-white">
                                    <h6 class="mb-0">Materials Pending QC</h6>
                                </div>
                                <div class="card-body p-0">
                                    {% if pending_qc_batches %}
                                        <div class="table-responsive">
                                            <table class="table table-sm table-striped mb-0">
                                                <thead>
                                                    <tr>
                                                        <th>Material</th>
                                                        <th>Batch</th>
                                                        <th>Quantity</th>
                                                        <th>Received</th>
                                                        <th>Status</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for batch in pending_qc_batches %}
                                                    <tr>
                                                        <td>{{ batch.material.material_name }}</td>
                                                        <td>{{ batch.batch_number }}</td>
                                                        <td>{{ batch.quantity_received }} {{ batch.material.unit_of_measure }}</td>
                                                        <td>{{ batch.received_date|date:"M d, Y" }}</td>
                                                        <td>
                                                            <span class="badge bg-warning">Pending QC</span>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    {% else %}
                                        <div class="text-center py-3 text-muted">
                                            <i class="fas fa-check-circle fa-2x mb-2"></i>
                                            <p>No materials pending QC approval</p>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="card border-success h-100">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0">Approved Materials</h6>
                                </div>
                                <div class="card-body p-0">
                                    {% if approved_materials %}
                                        <div class="table-responsive">
                                            <table class="table table-sm table-striped mb-0">
                                                <thead>
                                                    <tr>
                                                        <th>Material</th>
                                                        <th>Batch</th>
                                                        <th>Remaining</th>
                                                        <th>Expiry</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for batch in approved_materials %}
                                                    <tr>
                                                        <td>{{ batch.material.material_name }}</td>
                                                        <td>{{ batch.batch_number }}</td>
                                                        <td>{{ batch.quantity_remaining }} {{ batch.material.unit_of_measure }}</td>
                                                        <td>{{ batch.expiry_date|date:"M d, Y" }}</td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    {% else %}
                                        <div class="text-center py-3 text-muted">
                                            <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                                            <p>No approved materials available</p>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <div class="card border-danger h-100">
                                <div class="card-header bg-danger text-white">
                                    <h6 class="mb-0">Materials Expiring Soon</h6>
                                </div>
                                <div class="card-body p-0">
                                    {% if expiring_soon %}
                                        <div class="table-responsive">
                                            <table class="table table-sm table-striped mb-0">
                                                <thead>
                                                    <tr>
                                                        <th>Material</th>
                                                        <th>Batch</th>
                                                        <th>Remaining</th>
                                                        <th>Expiry</th>
                                                        <th>Days Left</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for batch in expiring_soon %}
                                                    <tr>
                                                        <td>{{ batch.material.material_name }}</td>
                                                        <td>{{ batch.batch_number }}</td>
                                                        <td>{{ batch.quantity_remaining }} {{ batch.material.unit_of_measure }}</td>
                                                        <td>{{ batch.expiry_date|date:"M d, Y" }}</td>
                                                        <td>
                                                            {% with days_left=batch.expiry_date|timeuntil %}
                                                                {% if "day" in days_left %}
                                                                    <span class="badge {% if days_left < '30 days' %}bg-danger{% else %}bg-warning{% endif %}">
                                                                        {{ days_left }}
                                                                    </span>
                                                                {% else %}
                                                                    <span class="badge bg-danger">{{ days_left }}</span>
                                                                {% endif %}
                                                            {% endwith %}
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    {% else %}
                                        <div class="text-center py-3 text-muted">
                                            <i class="fas fa-calendar-check fa-2x mb-2"></i>
                                            <p>No materials expiring soon</p>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recently Completed Releases -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-check-circle me-2"></i>Recently Completed Releases
                    </h5>
                </div>
                <div class="card-body">
                    {% if recently_completed %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>BMR Number</th>
                                        <th>Product</th>
                                        <th>Batch Size</th>
                                        <th>Completed</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for phase in recently_completed %}
                                    <tr>
                                        <td><strong class="text-primary">{{ phase.bmr.bmr_number }}</strong></td>
                                        <td>{{ phase.bmr.product.product_name }}</td>
                                        <td>{{ phase.bmr.batch_size|floatformat:0 }} {{ phase.bmr.product.unit_of_measure }}</td>
                                        <td>{{ phase.completed_date|date:"M d, H:i" }}</td>
                                        <td>
                                            <a href="{% url 'bmr:detail' phase.bmr.pk %}" 
                                               class="btn btn-outline-primary btn-sm">
                                                <i class="fas fa-eye"></i> View
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-4 text-muted">
                            <i class="fas fa-history fa-3x mb-3"></i>
                            <p>No recent releases completed</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Quick Start Actions -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-bolt me-2"></i>Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'bmr:list' %}" class="btn btn-primary">
                            <i class="fas fa-list me-2"></i>
                            View All BMRs
                        </a>
                        <a href="{% url 'admin:bmr_bmr_changelist' %}" class="btn btn-outline-primary">
                            <i class="fas fa-warehouse me-2"></i>
                            BMR Management
                        </a>
                        <a href="{% url 'admin:workflow_batchphaseexecution_changelist' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-tasks me-2"></i>
                            Phase Management
                        </a>
                        <button class="btn btn-outline-success" onclick="refreshDashboard()">
                            <i class="fas fa-sync-alt me-2"></i>
                            Refresh Dashboard
                        </button>
                    </div>
                </div>
            </div>

            <!-- Release Statistics -->
            <div class="card mt-3">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>Release Stats
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="border-end">
                                <h4 class="text-success">{{ stats.completed_today }}</h4>
                                <small class="text-muted">Today</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <h4 class="text-primary">{{ stats.total_batches }}</h4>
                            <small class="text-muted">Total</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function refreshDashboard() {
    window.location.reload();
}
function startRelease(bmrId, bmrNumber) {
    const notes = prompt(`Enter notes for starting raw material release for BMR ${bmrNumber}:`);
    if (notes !== null) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{% url "dashboards:store_dashboard" %}';
        
        // Add CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfToken) {
            form.appendChild(csrfToken.cloneNode());
        }
        
        // Add form data
        const fields = {
            'bmr_id': bmrId,
            'action': 'start',
            'notes': notes
        };
        
        for (const [key, value] of Object.entries(fields)) {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = key;
            input.value = value;
            form.appendChild(input);
        }
        
        document.body.appendChild(form);
        form.submit();
    }
}

function completeRelease(bmrId, bmrNumber) {
    const notes = prompt(`Enter notes for completing raw material release for BMR ${bmrNumber}:`);
    if (notes !== null) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{% url "dashboards:store_dashboard" %}';
        
        // Add CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfToken) {
            form.appendChild(csrfToken.cloneNode());
        }
        
        // Add form data
        const fields = {
            'bmr_id': bmrId,
            'action': 'complete',
            'notes': notes
        };
        
        for (const [key, value] of Object.entries(fields)) {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = key;
            input.value = value;
            form.appendChild(input);
        }
        
        document.body.appendChild(form);
        form.submit();
    }
}
</script>

<!-- CSRF Token for AJAX requests -->
{% csrf_token %}
{% endblock %}
