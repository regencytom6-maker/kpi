{% extends 'base.html' %}

{% block title %}Store Manager Dashboard - Kampala Pharmaceutical Industries{% endblock %}

{% block content %}
<!-- Fix URLs for API calls -->
<script>
// Intercept fetch calls to fix URLs with underscores
const originalFetch = window.fetch;
window.fetch = function() {
    // Convert the first argument (URL) if it's a string
    if (typeof arguments[0] === 'string') {
        // Replace raw_materials with raw-materials in API calls
        arguments[0] = arguments[0].replace('/raw_materials/api/', '/raw-materials/api/');
    }
    return originalFetch.apply(this, arguments);
};

// Also intercept jQuery ajax calls
if (window.jQuery) {
    const originalAjax = jQuery.ajax;
    jQuery.ajax = function(options) {
        if (typeof options.url === 'string') {
            options.url = options.url.replace('/raw_materials/api/', '/raw-materials/api/');
        }
        return originalAjax.call(this, options);
    };
}
</script>

<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="text-primary mb-0">
                        <i class="fas fa-warehouse me-2"></i>Store Manager Dashboard
                    </h2>
                    <p class="text-muted mb-0">Raw Material Release Management</p>
                </div>
                <div>             
                    <small class="text-muted">Welcome, {{ user.get_full_name|default:user.username }}</small><br>
                    <small class="text-success">{{ user.get_role_display }}</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title mb-0">{{ stats.pending_phases }}</h5>
                            <p class="card-text">Pending Releases</p>
                        </div>
                        <i class="fas fa-clock fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title mb-0">{{ stats.in_progress_phases }}</h5>
                            <p class="card-text">In Progress</p>
                        </div>
                        <i class="fas fa-box fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title mb-0">{{ stats.completed_today }}</h5>
                            <p class="card-text">Completed Today</p>
                        </div>
                        <i class="fas fa-check-circle fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title mb-0">{{ stats.total_batches }}</h5>
                            <p class="card-text">Total Batches</p>
                        </div>
                        <i class="fas fa-cubes fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- Sidebar Navigation -->
        <div class="col-md-3">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Store Dashboard</h5>
                </div>
                <div class="list-group list-group-flush" id="store-sidebar-tabs" role="tablist">
                    <a class="list-group-item list-group-item-action active" id="raw-material-release-tab" data-bs-toggle="tab" href="#raw-material-release" role="tab" aria-controls="raw-material-release" aria-selected="true">
                        <i class="fas fa-box-open me-2"></i> Raw Material Release
                    </a>
                    <a class="list-group-item list-group-item-action" id="receive-batch-tab" data-bs-toggle="tab" href="#receive-batch" role="tab" aria-controls="receive-batch" aria-selected="false">
                        <i class="fas fa-truck-loading me-2"></i> Receive Raw Materials
                    </a>
                    <a class="list-group-item list-group-item-action" id="inventory-tab" data-bs-toggle="tab" href="#inventory" role="tab" aria-controls="inventory" aria-selected="false">
                        <i class="fas fa-warehouse me-2"></i> Inventory Management
                    </a>
                    <a class="list-group-item list-group-item-action" id="materials-tab" data-bs-toggle="tab" href="#materials" role="tab" aria-controls="materials" aria-selected="false">
                        <i class="fas fa-flask me-2"></i> Raw Materials
                    </a>
                    <a class="list-group-item list-group-item-action" id="add-material-tab" data-bs-toggle="tab" href="#add-material" role="tab" aria-controls="add-material" aria-selected="false">
                        <i class="fas fa-plus-circle me-2"></i> Add New Material
                    </a>
                </div>
                
                <!-- Enhanced Sidebar Menu -->
                <div class="card mt-4">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">Quick Access</h5>
                    </div>
                    <div class="list-group list-group-flush">
                        <a href="#" class="list-group-item list-group-item-action sidebar-nav-item" data-section="pending_qc">
                            <div class="d-flex justify-content-between align-items-center">
                                <div><i class="fas fa-flask me-2"></i> Pending QC</div>
                                <span class="badge bg-warning rounded-pill">{{ stats.pending_qc_count }}</span>
                            </div>
                        </a>
                        <a href="#" class="list-group-item list-group-item-action sidebar-nav-item" data-section="approved">
                            <div class="d-flex justify-content-between align-items-center">
                                <div><i class="fas fa-check-circle me-2"></i> Approved</div>
                                <span class="badge bg-success rounded-pill">{{ stats.approved_count }}</span>
                            </div>
                        </a>
                        <a href="#" class="list-group-item list-group-item-action sidebar-nav-item" data-section="dispensing">
                            <div class="d-flex justify-content-between align-items-center">
                                <div><i class="fas fa-prescription-bottle me-2"></i> Pending Dispensing</div>
                                <span class="badge bg-primary rounded-pill">{{ pending_dispensing }}</span>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Section Containers - Hidden by Default -->
            <div id="pendingQCSection" class="d-none"></div>
            <div id="approvedSection" class="d-none"></div>
            <div id="dispensingSection" class="d-none"></div>
            <div id="inventorySection" class="d-none"></div>
            <div id="expirySection" class="d-none"></div>
            <div id="recentReleasesSection" class="d-none"></div>
        </div>

        <!-- Main Content Area -->
        <div class="col-md-9">
            <div class="tab-content">
                <!-- Raw Material Release Tab -->
                <div class="tab-pane fade show active" id="raw-material-release" role="tabpanel" aria-labelledby="raw-material-release-tab">
                    <!-- Raw Material Release Queue -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-warehouse me-2"></i>Raw Material Release Queue
                            </h5>
                        </div>
                        <div class="card-body">
                            {% if my_phases %}
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover">
                                        <thead>
                                            <tr>
                                                <th>BMR Number</th>
                                                <th>Product</th>
                                                <th>Batch Size</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for phase in my_phases %}
                                                {% if phase.phase.phase_name == 'raw_material_release' %}
                                                <tr>
                                                    <td>{{ phase.bmr.batch_number }}</td>
                                                    <td>{{ phase.bmr.product.product_name }}</td>
                                                    <td>{{ phase.bmr.batch_size|floatformat:0 }} {{ phase.bmr.product.unit_of_measure }}</td>
                                                    <td>
                                                        {% if phase.status == 'pending' %}
                                                            <span class="badge bg-warning">Pending</span>
                                                        {% elif phase.status == 'in_progress' %}
                                                            <span class="badge bg-info">In Progress</span>
                                                        {% elif phase.status == 'completed' %}
                                                            <span class="badge bg-success">Completed</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        {% if phase.status == 'pending' %}
                                                            <button class="btn btn-sm btn-primary" onclick="startRelease({{ phase.bmr.id }}, '{{ phase.bmr.batch_number }}')">
                                                                <i class="fas fa-play me-1"></i>Start
                                                            </button>
                                                        {% elif phase.status == 'in_progress' %}
                                                            <button class="btn btn-sm btn-success" onclick="completeRelease({{ phase.bmr.id }}, '{{ phase.bmr.batch_number }}')">
                                                                <i class="fas fa-check me-1"></i>Complete
                                                            </button>
                                                        {% else %}
                                                            <span class="text-muted">Completed</span>
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                                {% endif %}
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i> No raw material releases pending.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Other tabs content would go here -->
            </div>
        </div>
    </div>
</div>

<script>
// Set up CSRF token for AJAX requests
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Set up CSRF token header for all AJAX requests
const csrftoken = getCookie('csrftoken');
$.ajaxSetup({
    beforeSend: function(xhr, settings) {
        if (!(/^(GET|HEAD|OPTIONS|TRACE)$/.test(settings.type)) && !this.crossDomain) {
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
        }
    }
});

// Function to load section directly by name without page reload
function loadSectionByName(section) {
    console.log("Loading section by name:", section);
    
    // Update URL for bookmarking without reload
    const url = new URL(window.location);
    url.searchParams.set('section', section);
    window.history.pushState({}, '', url);
    
    // First hide everything - thoroughly
    $('#store-sidebar-tabs, .tab-content, .tab-pane').hide();
    $('.tab-pane').removeClass('show active');
    
    // Add a class to body to indicate we're in a section view
    $('body').addClass('section-view-active');
    
    // Hide all section containers
    const allSections = $('#pendingQCSection, #approvedSection, #dispensingSection, #inventorySection, #expirySection, #recentReleasesSection');
    allSections.hide();
    allSections.css('display', 'none');
    allSections.removeClass('active');
    
    // Remove active class from all sidebar items
    $('.sidebar-nav-item').removeClass('active');
    
    // Add active class to the clicked item
    $(`.sidebar-nav-item[data-section="${section}"]`).addClass('active');
    
    // Load specific section based on parameter
    if (section === 'pending_qc') {
        console.log("Loading pending QC section");
        showSection('pendingQCSection');
        loadPendingQCSection();
    } else if (section === 'approved') {
        console.log("Loading approved section");
        showSection('approvedSection');
        loadApprovedSection();
    } else if (section === 'dispensing') {
        console.log("Loading dispensing section");
        showSection('dispensingSection');
        loadDispensingSection();
    } else {
        // Default to showing the main dashboard
        resetDashboard();
    }
}

// Helper function to show a section
function showSection(sectionId) {
    const section = $(`#${sectionId}`);
    
    // Clear previous content
    section.empty();
    
    // Make it visible using multiple techniques for maximum compatibility
    section.show();
    section.css({
        'display': 'block',
        'visibility': 'visible',
        'opacity': '1',
        'z-index': '2000',
        'position': 'relative'
    });
    
    // Force it to be visible with inline style
    section.attr('style', 'display: block !important; position: relative !important; z-index: 2000 !important; visibility: visible !important; opacity: 1 !important;');
    
    // Add active class
    section.addClass('active');
    
    // Return the section for chaining
    return section;
}

// Function to reset dashboard to default view
function resetDashboard() {
    console.log("Resetting dashboard to default view");
    
    // Remove section-view-active class from body
    $('body').removeClass('section-view-active');
    
    // Show tab content and navigation
    $('#store-sidebar-tabs, .tab-content').show();
    
    // Hide all custom sections
    const sections = $('#pendingQCSection, #approvedSection, #dispensingSection, #inventorySection, #expirySection, #recentReleasesSection');
    sections.hide();
    sections.css('display', 'none');
    sections.removeAttr('style');
    sections.removeClass('active');
    
    // Remove active class from all sidebar items
    $('.sidebar-nav-item').removeClass('active');
    
    // Reset and activate the default tab
    $('.tab-pane').removeClass('show active');
    $('#raw-material-release').addClass('show active');
    $('#raw-material-release-tab').tab('show');
    
    // Update URL without reload
    history.pushState({}, '', '?');
}

// Functions to load specific section content
function loadPendingQCSection() {
    console.log("Loading Pending QC section");
    
    // Create HTML with the data
    $('#pendingQCSection').html(`
        <div class="card mb-3">
            <div class="card-header bg-warning text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-flask me-2"></i>Materials Pending QC</h5>
                <button onclick="resetDashboard()" class="btn btn-sm btn-outline-light">
                    <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Material</th>
                                <th>Batch Number</th>
                                <th>Date Received</th>
                                <th>Quantity</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if pending_qc_batches %}
                                {% for batch in pending_qc_batches %}
                                <tr>
                                    <td>{{ batch.material.material_name }}</td>
                                    <td>{{ batch.batch_number }}</td>
                                    <td>{{ batch.received_date|date:"Y-m-d" }}</td>
                                    <td>{{ batch.quantity_received }} {{ batch.material.unit_of_measure }}</td>
                                    <td>
                                        <a href="{% url 'raw_materials:batch_detail' batch.id %}" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-eye me-1"></i>Details
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="5" class="text-center py-3">
                                        <i class="fas fa-info-circle text-info me-2"></i>
                                        No materials pending QC
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `);
}

function loadApprovedSection() {
    console.log("Loading Approved section");
    
    // Create HTML with the data
    $('#approvedSection').html(`
        <div class="card mb-3">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-check-double me-2"></i>Approved Materials</h5>
                <button onclick="resetDashboard()" class="btn btn-sm btn-outline-light">
                    <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Material</th>
                                <th>Batch Number</th>
                                <th>Date Received</th>
                                <th>Quantity Remaining</th>
                                <th>Expiry Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if approved_materials %}
                                {% for batch in approved_materials %}
                                <tr>
                                    <td>{{ batch.material.material_name }}</td>
                                    <td>{{ batch.batch_number }}</td>
                                    <td>{{ batch.received_date|date:"Y-m-d" }}</td>
                                    <td>{{ batch.quantity_remaining }} {{ batch.material.unit_of_measure }}</td>
                                    <td>{{ batch.expiry_date|date:"Y-m-d" }}</td>
                                    <td>
                                        <a href="{% url 'raw_materials:batch_detail' batch.id %}" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-eye me-1"></i>Details
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="6" class="text-center py-3">
                                        <i class="fas fa-info-circle text-info me-2"></i>
                                        No approved materials found
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `);
}

function loadDispensingSection() {
    console.log("Loading Dispensing section");
    
    // Create HTML with the data
    $('#dispensingSection').html(`
        <div class="card mb-3">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-prescription-bottle me-2"></i>Pending Material Dispensing</h5>
                <button onclick="resetDashboard()" class="btn btn-sm btn-outline-light">
                    <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                </button>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    There are currently {{ pending_dispensing }} batches pending material dispensing.
                </div>
                <div class="text-center">
                    <a href="{% url 'raw_materials:dispensing_dashboard' %}" class="btn btn-primary">
                        <i class="fas fa-external-link-alt me-2"></i>
                        Go to Dispensing Dashboard
                    </a>
                </div>
            </div>
        </div>
    `);
}

function startRelease(bmrId, bmrNumber) {
    const notes = prompt(`Enter notes for starting raw material release for BMR ${bmrNumber}:`);
    if (notes !== null) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{% url "dashboards:store_dashboard" %}';
        
        // Add CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfToken) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrfToken.value;
            form.appendChild(csrfInput);
        }
        
        // Add form fields
        const bmrIdInput = document.createElement('input');
        bmrIdInput.type = 'hidden';
        bmrIdInput.name = 'bmr_id';
        bmrIdInput.value = bmrId;
        form.appendChild(bmrIdInput);
        
        const actionInput = document.createElement('input');
        actionInput.type = 'hidden';
        actionInput.name = 'action';
        actionInput.value = 'start';
        form.appendChild(actionInput);
        
        const notesInput = document.createElement('input');
        notesInput.type = 'hidden';
        notesInput.name = 'notes';
        notesInput.value = notes;
        form.appendChild(notesInput);
        
        // Submit form
        document.body.appendChild(form);
        form.submit();
    }
}

function completeRelease(bmrId, bmrNumber) {
    const notes = prompt(`Enter notes for completing raw material release for BMR ${bmrNumber}:`);
    if (notes !== null) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{% url "dashboards:store_dashboard" %}';
        
        // Add CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfToken) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrfToken.value;
            form.appendChild(csrfInput);
        }
        
        // Add form fields
        const bmrIdInput = document.createElement('input');
        bmrIdInput.type = 'hidden';
        bmrIdInput.name = 'bmr_id';
        bmrIdInput.value = bmrId;
        form.appendChild(bmrIdInput);
        
        const actionInput = document.createElement('input');
        actionInput.type = 'hidden';
        actionInput.name = 'action';
        actionInput.value = 'complete';
        form.appendChild(actionInput);
        
        const notesInput = document.createElement('input');
        notesInput.type = 'hidden';
        notesInput.name = 'notes';
        notesInput.value = notes;
        form.appendChild(notesInput);
        
        // Submit form
        document.body.appendChild(form);
        form.submit();
    }
}

// Initialize tabs and sidebar navigation
document.addEventListener('DOMContentLoaded', function() {
    // Initialize bootstrap tabs
    var triggerTabList = [].slice.call(document.querySelectorAll('#store-sidebar-tabs a'))
    triggerTabList.forEach(function(triggerEl) {
        var tabTrigger = new bootstrap.Tab(triggerEl)
        
        triggerEl.addEventListener('click', function(event) {
            event.preventDefault()
            tabTrigger.show()
        })
    })

    // Add sidebar navigation event listeners
    $(".sidebar-nav-item").on("click", function(e) {
        e.preventDefault();
        const section = $(this).data("section");
        console.log("Sidebar item clicked:", section);
        loadSectionByName(section);
    });
    
    // Handle URL parameters on page load
    const urlParams = new URLSearchParams(window.location.search);
    const section = urlParams.get('section');
    if (section) {
        loadSectionByName(section);
    }
});
</script>

<!-- CSRF Token for AJAX requests -->
{% csrf_token %}
{% endblock %}
