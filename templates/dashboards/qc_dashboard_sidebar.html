{% extends 'base.html' %}

{% block title %}Quality Control Dashboard - Kampala Pharmaceutical Industries{% endblock %}

{% block extra_css %}
<style>
    @keyframes blink {
        0% { opacity: 1; }
        50% { opacity: 0.3; }
        100% { opacity: 1; }
    }
    .blink-badge {
        animation: blink 1.5s linear infinite;
    }
    
    .sidebar {
        min-height: calc(100vh - 100px);
        border-right: 1px solid #dee2e6;
        background-color: #f8f9fa;
    }
    
    .sidebar .nav-link {
        color: #495057;
        border-radius: 0;
        padding: 0.8rem 1.5rem;
        border-left: 4px solid transparent;
    }
    
    .sidebar .nav-link:hover {
        background-color: #e9ecef;
    }
    
    .sidebar .nav-link.active {
        color: #0d6efd;
        background-color: #e9ecef;
        border-left: 4px solid #0d6efd;
        font-weight: 500;
    }
    
    .main-content {
        padding-left: 15px;
    }
    
    @media (max-width: 991.98px) {
        .sidebar {
            min-height: auto;
            border-right: none;
            border-bottom: 1px solid #dee2e6;
            margin-bottom: 1rem;
        }
        
        .main-content {
            padding-left: 0;
        }
    }
    
    .sidebar-alert {
        position: relative;
    }
    
    .sidebar-alert .badge {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="text-primary mb-0">
                        <i class="fas fa-microscope me-2"></i>Quality Control Dashboard
                    </h2>
                    <p class="text-muted mb-0">Product Testing & Quality Verification</p>
                </div>
                <div class="text-end">
                    <small class="text-muted">Welcome, {{ user.get_full_name|default:user.username }}</small><br>
                    <small class="text-success">{{ user.get_role_display }}</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title mb-0">{{ stats.pending_tests }}</h5>
                            <p class="card-text">Pending Tests</p>
                        </div>
                        <i class="fas fa-clock fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title mb-0">
                                {{ stats.pending_raw_materials }}
                                {% if stats.pending_raw_materials > 0 %}
                                    <span class="badge bg-danger blink-badge">New</span>
                                {% endif %}
                            </h5>
                            <p class="card-text">Materials Pending QC</p>
                        </div>
                        <i class="fas fa-vial fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title mb-0">{{ stats.passed_today }}</h5>
                            <p class="card-text">Passed Today</p>
                        </div>
                        <i class="fas fa-check-circle fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title mb-0">{{ stats.failed_this_week }}</h5>
                            <p class="card-text">Failed This Week</p>
                        </div>
                        <i class="fas fa-times-circle fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <!-- Sidebar Navigation -->
        <div class="col-lg-3 col-md-4 mb-4">
            <div class="sidebar">
                <div class="list-group list-group-flush">
                    <h5 class="px-3 py-2 mb-0 border-bottom bg-light">QC Navigation</h5>
                    
                    <a href="#" class="nav-link active" id="pending-tests-link" data-bs-toggle="tab" data-bs-target="#pending-tests">
                        <i class="fas fa-flask me-2"></i>Pending Tests
                    </a>
                    
                    <a href="#" class="nav-link sidebar-alert {% if stats.pending_raw_materials > 0 %}text-danger{% endif %}" id="raw-materials-link" data-bs-toggle="tab" data-bs-target="#raw-materials">
                        <i class="fas fa-boxes me-2"></i>Raw Materials QC
                        {% if stats.pending_raw_materials > 0 %}
                            <span class="badge bg-danger">{{ stats.pending_raw_materials }}</span>
                        {% endif %}
                    </a>
                    
                    <a href="#" class="nav-link" id="in-progress-link" data-bs-toggle="tab" data-bs-target="#in-progress">
                        <i class="fas fa-spinner me-2"></i>In Progress Tests
                    </a>
                    
                    <a href="#" class="nav-link" id="completed-link" data-bs-toggle="tab" data-bs-target="#completed">
                        <i class="fas fa-check-double me-2"></i>Completed Tests
                    </a>
                    
                    <a href="#" class="nav-link" id="reports-link" data-bs-toggle="tab" data-bs-target="#reports">
                        <i class="fas fa-chart-bar me-2"></i>QC Reports
                    </a>
                    
                    <a href="#" class="nav-link" id="specifications-link" data-bs-toggle="tab" data-bs-target="#specifications">
                        <i class="fas fa-clipboard-list me-2"></i>Specifications
                    </a>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-lg-9 col-md-8">
            <div class="tab-content" id="qcTabsContent">
                <!-- Pending Tests Tab -->
                <div class="tab-pane fade show active" id="pending-tests" role="tabpanel">
                    <div class="card">
                        <div class="card-header bg-warning text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-flask me-2"></i>Pending Quality Control Tests
                            </h5>
                        </div>
                        <div class="card-body">
                            <!-- Tab content for pending tests -->
                            {% if pending_tests %}
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>BMR Number</th>
                                                <th>Product</th>
                                                <th>Phase</th>
                                                <th>Submitted</th>
                                                <th>Priority</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for test in pending_tests %}
                                            <tr>
                                                <td><strong class="text-primary">{{ test.bmr.bmr_number }}</strong></td>
                                                <td>{{ test.bmr.product.product_name }}</td>
                                                <td>{{ test.phase_name }}</td>
                                                <td>{{ test.created_date|date:"M d, H:i" }}</td>
                                                <td>
                                                    {% if test.created_date|timesince|slice:":1" == "0" %}
                                                        <span class="badge bg-danger">Urgent</span>
                                                    {% elif test.created_date|timesince|slice:":1" == "1" %}
                                                        <span class="badge bg-warning">High</span>
                                                    {% else %}
                                                        <span class="badge bg-success">Normal</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <div class="btn-group btn-group-sm">
                                                        <button class="btn btn-outline-primary"
                                                                onclick="viewTestDetails('{{ test.id }}')">
                                                            <i class="fas fa-eye"></i> View
                                                        </button>
                                                        <button class="btn btn-outline-success"
                                                                onclick="startTest('{{ test.id }}')">
                                                            <i class="fas fa-play"></i> Start
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="text-center py-5">
                                    <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                                    <h5 class="text-muted">No Pending Tests</h5>
                                    <p class="text-muted">All quality control tests are up to date.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Raw Materials QC Tab -->
                <div class="tab-pane fade" id="raw-materials" role="tabpanel">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-boxes me-2"></i>Raw Materials Quality Control Testing Queue
                            </h5>
                        </div>
                        <div class="card-body">
                            {% if pending_material_tests %}
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>Material</th>
                                                <th>Batch Number</th>
                                                <th>Quantity</th>
                                                <th>Received Date</th>
                                                <th>Supplier</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for test in pending_material_tests %}
                                            <tr>
                                                <td><strong>{{ test.material.material_name }}</strong></td>
                                                <td>{{ test.batch_number }}</td>
                                                <td>{{ test.quantity }} {{ test.material.unit_of_measure }}</td>
                                                <td>{{ test.received_date|date:"M d, Y" }}</td>
                                                <td>{{ test.supplier_info|truncatechars:30 }}</td>
                                                <td>
                                                    <div class="btn-group btn-group-sm">
                                                        <button class="btn btn-outline-primary"
                                                                onclick="viewRawMaterialBatch('{{ test.id }}')">
                                                            <i class="fas fa-eye"></i> View
                                                        </button>
                                                        <button class="btn btn-outline-success"
                                                                onclick="startRawMaterialTest('{{ test.id }}')">
                                                            <i class="fas fa-play"></i> Start QC Test
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="text-center py-5">
                                    <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                                    <h5 class="text-muted">No Pending Raw Material Tests</h5>
                                    <p class="text-muted">All raw materials have been tested.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- In Progress Tests Tab -->
                <div class="tab-pane fade" id="in-progress" role="tabpanel">
                    <div class="row">
                        <!-- In Progress Product Tests -->
                        <div class="col-12 mb-4">
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <h5 class="mb-0">In Progress Product Tests</h5>
                                </div>
                                <div class="card-body">
                                    {% if in_progress_tests %}
                                        <div class="table-responsive">
                                            <table class="table table-striped table-hover">
                                                <thead class="table-dark">
                                                    <tr>
                                                        <th>BMR Number</th>
                                                        <th>Product</th>
                                                        <th>Phase</th>
                                                        <th>Started</th>
                                                        <th>Operator</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for test in in_progress_tests %}
                                                    <tr>
                                                        <td><strong class="text-primary">{{ test.bmr.bmr_number }}</strong></td>
                                                        <td>{{ test.bmr.product.product_name }}</td>
                                                        <td>{{ test.phase_name }}</td>
                                                        <td>{{ test.started_date|date:"M d, H:i" }}</td>
                                                        <td>{{ test.operator.get_full_name|default:test.operator.username }}</td>
                                                        <td>
                                                            <button class="btn btn-outline-warning btn-sm"
                                                                    onclick="completeTest('{{ test.id }}')">
                                                                <i class="fas fa-check"></i> Complete
                                                            </button>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    {% else %}
                                        <p>No in-progress tests</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- In Progress Raw Material Tests -->
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <h5 class="mb-0">In Progress Raw Material Tests</h5>
                                </div>
                                <div class="card-body">
                                    {% if in_progress_material_tests %}
                                        <div class="table-responsive">
                                            <table class="table table-striped table-hover">
                                                <thead class="table-dark">
                                                    <tr>
                                                        <th>Material</th>
                                                        <th>Batch Number</th>
                                                        <th>Started</th>
                                                        <th>Operator</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for test in in_progress_material_tests %}
                                                    <tr>
                                                        <td><strong>{{ test.material.material_name }}</strong></td>
                                                        <td>{{ test.batch_number }}</td>
                                                        <td>{{ test.started_date|date:"M d, H:i" }}</td>
                                                        <td>{{ test.operator.get_full_name|default:test.operator.username }}</td>
                                                        <td>
                                                            <button class="btn btn-outline-warning btn-sm"
                                                                    onclick="completeRawMaterialTest('{{ test.id }}')">
                                                                <i class="fas fa-check"></i> Complete
                                                            </button>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    {% else %}
                                        <p>No in-progress material tests</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Completed Tests Tab -->
                <div class="tab-pane fade" id="completed" role="tabpanel">
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-check-double me-2"></i>Completed Tests
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <h6 class="mb-0">Product Test Results</h6>
                                            <hr>
                                            <canvas id="testResultChart" width="100%" height="200"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <h6 class="mb-0">Raw Material Test Results</h6>
                                            <hr>
                                            <canvas id="materialTestChart" width="100%" height="200"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Recent Test Results Table -->
                            <h6>Recent Test Results</h6>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Date</th>
                                            <th>Type</th>
                                            <th>Item</th>
                                            <th>Batch</th>
                                            <th>Result</th>
                                            <th>Tester</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for result in recent_results %}
                                        <tr>
                                            <td>{{ result.completed_date|date:"M d, H:i" }}</td>
                                            <td>
                                                {% if result.test_type == 'product' %}
                                                    <span class="badge bg-primary">Product</span>
                                                {% else %}
                                                    <span class="badge bg-info">Raw Material</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if result.test_type == 'product' %}
                                                    {{ result.bmr.product.product_name }}
                                                {% else %}
                                                    {{ result.material.material_name }}
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if result.test_type == 'product' %}
                                                    {{ result.bmr.bmr_number }}
                                                {% else %}
                                                    {{ result.batch_number }}
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if result.result == 'pass' %}
                                                    <span class="badge bg-success">Passed</span>
                                                {% elif result.result == 'fail' %}
                                                    <span class="badge bg-danger">Failed</span>
                                                {% else %}
                                                    <span class="badge bg-warning">{{ result.result|title }}</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ result.operator.get_full_name|default:result.operator.username }}</td>
                                            <td>
                                                <button class="btn btn-outline-primary btn-sm"
                                                        onclick="viewTestResult('{{ result.id }}')">
                                                    <i class="fas fa-eye"></i> View
                                                </button>
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="7" class="text-center">No completed tests found</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reports Tab -->
                <div class="tab-pane fade" id="reports" role="tabpanel">
                    <div class="card">
                        <div class="card-header bg-secondary text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-chart-bar me-2"></i>QC Reports
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">Generate Report</div>
                                        <div class="card-body">
                                            <form id="reportForm">
                                                <div class="mb-3">
                                                    <label class="form-label">Report Type</label>
                                                    <select class="form-select" id="reportType">
                                                        <option value="">Select Report Type</option>
                                                        <option value="product">Product Tests</option>
                                                        <option value="raw_material">Raw Materials</option>
                                                        <option value="failure">Failure Analysis</option>
                                                        <option value="trending">Trending Analysis</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Date Range</label>
                                                    <div class="input-group">
                                                        <input type="date" class="form-control" id="startDate">
                                                        <span class="input-group-text">to</span>
                                                        <input type="date" class="form-control" id="endDate">
                                                    </div>
                                                </div>
                                                <div class="text-end">
                                                    <button type="button" class="btn btn-primary" onclick="generateReport()">
                                                        <i class="fas fa-file-pdf me-2"></i>Generate Report
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-header">Saved Reports</div>
                                        <div class="card-body">
                                            <div class="list-group">
                                                {% for report in saved_reports %}
                                                <a href="#" class="list-group-item list-group-item-action">
                                                    <div class="d-flex w-100 justify-content-between">
                                                        <h6 class="mb-1">{{ report.title }}</h6>
                                                        <small>{{ report.created_date|date:"M d" }}</small>
                                                    </div>
                                                    <p class="mb-1 small text-muted">{{ report.description }}</p>
                                                </a>
                                                {% empty %}
                                                <p class="text-muted">No saved reports</p>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Specifications Tab -->
                <div class="tab-pane fade" id="specifications" role="tabpanel">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-clipboard-list me-2"></i>Specifications
                            </h5>
                        </div>
                        <div class="card-body">
                            <ul class="nav nav-pills mb-3" id="specTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#products-spec" type="button">Products</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" data-bs-toggle="pill" data-bs-target="#materials-spec" type="button">Raw Materials</button>
                                </li>
                            </ul>
                            <div class="tab-content border-top pt-3" id="specTabsContent">
                                <div class="tab-pane fade show active" id="products-spec" role="tabpanel">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>Product Name</th>
                                                <th>Type</th>
                                                <th>Parameters</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for spec in product_specs %}
                                            <tr>
                                                <td>{{ spec.product.product_name }}</td>
                                                <td>{{ spec.product.get_product_type_display }}</td>
                                                <td>{{ spec.parameter_count }} parameters</td>
                                                <td>
                                                    <button class="btn btn-sm btn-outline-primary">
                                                        <i class="fas fa-eye"></i> View
                                                    </button>
                                                </td>
                                            </tr>
                                            {% empty %}
                                            <tr>
                                                <td colspan="4" class="text-center">No product specifications found</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                <div class="tab-pane fade" id="materials-spec" role="tabpanel">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>Material Name</th>
                                                <th>Type</th>
                                                <th>Parameters</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for spec in material_specs %}
                                            <tr>
                                                <td>{{ spec.material.material_name }}</td>
                                                <td>{{ spec.material.get_material_type_display }}</td>
                                                <td>{{ spec.parameter_count }} parameters</td>
                                                <td>
                                                    <button class="btn btn-sm btn-outline-primary">
                                                        <i class="fas fa-eye"></i> View
                                                    </button>
                                                </td>
                                            </tr>
                                            {% empty %}
                                            <tr>
                                                <td colspan="4" class="text-center">No material specifications found</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Raw Material QC Test Modal -->
<div class="modal fade" id="rawMaterialQcModal" tabindex="-1" aria-labelledby="rawMaterialQcModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="rawMaterialQcModalLabel">Raw Material Quality Control Test</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="rawMaterialQcModalBody">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Product Test Modal -->
<div class="modal fade" id="productTestModal" tabindex="-1" aria-labelledby="productTestModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="productTestModalLabel">Product Quality Control Test</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="productTestModalBody">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Create test result charts
        createTestResultChart();
        createMaterialTestChart();
        
        // Initialize sidebar links with tab functionality
        document.querySelectorAll('.sidebar .nav-link').forEach(function(link) {
            link.addEventListener('click', function(event) {
                event.preventDefault();
                
                // Remove active class from all links
                document.querySelectorAll('.sidebar .nav-link').forEach(function(l) {
                    l.classList.remove('active');
                });
                
                // Add active class to clicked link
                this.classList.add('active');
                
                // Get target from data attribute and show tab
                var targetId = this.getAttribute('data-bs-target');
                var tab = new bootstrap.Tab(this);
                tab.show();
            });
        });
    });
    
    function createTestResultChart() {
        var ctx = document.getElementById('testResultChart').getContext('2d');
        var testChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['Pass', 'Fail', 'Pending Retest'],
                datasets: [{
                    data: [{{ stats.pass_count|default:0 }}, {{ stats.fail_count|default:0 }}, {{ stats.retest_count|default:0 }}],
                    backgroundColor: [
                        'rgba(75, 192, 75, 0.7)',
                        'rgba(255, 99, 132, 0.7)',
                        'rgba(255, 205, 86, 0.7)'
                    ],
                    borderColor: [
                        'rgba(75, 192, 75, 1)',
                        'rgba(255, 99, 132, 1)',
                        'rgba(255, 205, 86, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
    
    function createMaterialTestChart() {
        var ctx = document.getElementById('materialTestChart').getContext('2d');
        var materialChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['Pass', 'Fail', 'Pending Retest'],
                datasets: [{
                    data: [{{ stats.material_pass_count|default:0 }}, {{ stats.material_fail_count|default:0 }}, {{ stats.material_retest_count|default:0 }}],
                    backgroundColor: [
                        'rgba(75, 192, 75, 0.7)',
                        'rgba(255, 99, 132, 0.7)',
                        'rgba(255, 205, 86, 0.7)'
                    ],
                    borderColor: [
                        'rgba(75, 192, 75, 1)',
                        'rgba(255, 99, 132, 1)',
                        'rgba(255, 205, 86, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
    
    // Start a product test
    function startTest(testId) {
        if(confirm('Start quality control test?')) {
            $.ajax({
                type: 'POST',
                url: '{% url "raw_materials:save_qc_test" %}',
                data: {
                    'action': 'start',
                    'test_id': testId,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function(response) {
                    if(response.status === 'success') {
                        location.reload();
                    } else {
                        alert('Error: ' + response.message);
                    }
                }
            });
        }
    }
    
    // Complete a product test
    function completeTest(testId) {
        showProductTestModal(testId);
    }
    
    // View product test details
    function viewTestDetails(testId) {
        showProductTestModal(testId, true);
    }
    
    // Show product test modal
    function showProductTestModal(testId, readOnly = false) {
        var modal = new bootstrap.Modal(document.getElementById('productTestModal'));
        modal.show();
        
        $.ajax({
            type: 'GET',
            url: '{% url "raw_materials:api_qc_test_detail" %}',
            data: {
                'test_id': testId,
                'read_only': readOnly ? '1' : '0'
            },
            success: function(response) {
                if(response.status === 'success') {
                    $('#productTestModalBody').html(response.html);
                } else {
                    $('#productTestModalBody').html('<div class="alert alert-danger">Error loading test details.</div>');
                }
            },
            error: function() {
                $('#productTestModalBody').html('<div class="alert alert-danger">Error loading test details.</div>');
            }
        });
    }
    
    // Start a raw material test
    function startRawMaterialTest(batchId) {
        if(confirm('Start raw material quality control test?')) {
            $.ajax({
                type: 'POST',
                url: '{% url "raw_materials:save_qc_test" %}',
                data: {
                    'action': 'start_material',
                    'batch_id': batchId,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function(response) {
                    if(response.status === 'success') {
                        location.reload();
                    } else {
                        alert('Error: ' + response.message);
                    }
                }
            });
        }
    }
    
    // Complete a raw material test
    function completeRawMaterialTest(testId) {
        showRawMaterialTestModal(testId);
    }
    
    // View raw material batch details
    function viewRawMaterialBatch(batchId) {
        showRawMaterialTestModal(batchId, true);
    }
    
    // Show raw material test modal
    function showRawMaterialTestModal(testId, readOnly = false) {
        var modal = new bootstrap.Modal(document.getElementById('rawMaterialQcModal'));
        modal.show();
        
        $.ajax({
            type: 'GET',
            url: '{% url "raw_materials:api_batch_detail" %}',
            data: {
                'batch_id': testId,
                'read_only': readOnly ? '1' : '0'
            },
            success: function(response) {
                if(response.status === 'success') {
                    $('#rawMaterialQcModalBody').html(response.html);
                } else {
                    $('#rawMaterialQcModalBody').html('<div class="alert alert-danger">Error loading batch details.</div>');
                }
            },
            error: function() {
                $('#rawMaterialQcModalBody').html('<div class="alert alert-danger">Error loading batch details.</div>');
            }
        });
    }
    
    // View test result details
    function viewTestResult(resultId) {
        // Implementation for viewing test results
        alert('Test result details functionality will be implemented soon.');
    }
    
    // Generate report
    function generateReport() {
        var reportType = $('#reportType').val();
        var startDate = $('#startDate').val();
        var endDate = $('#endDate').val();
        
        if(!reportType || !startDate || !endDate) {
            alert('Please fill in all report parameters.');
            return;
        }
        
        alert('Report generation functionality will be implemented soon.');
    }
</script>
{% endblock %}
