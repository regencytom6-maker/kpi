{% extends 'base.html' %}

{% block title %}Store Manager Dashboard - Kampala Pharmaceutical Industries{% endblock %}

<!-- Version: 2025-08-25-001 - Force browser cache refresh -->

{% block styles %}
<style>
    /* Inventory table styles */
    .product-tags {
        max-width: 200px;
        overflow-x: hidden;
    }
    
    .product-tags .badge {
        display: inline-block;
        margin-right: 3px;
        margin-bottom: 3px;
        white-space: nowrap;
    }
    
    /* Detailed view styles */
    .associated-products {
        max-height: 200px;
        overflow-y: auto;
    }
    
    #inventoryTable th, #inventoryTable td {
        vertical-align: middle;
    }
    
    /* Ensure sections are visible when needed */
    #releaseQueueSection, #pendingQCSection, #approvedSection, #dispensingSection, 
    #inventorySection, #expirySection, #recentReleasesSection, #recentReceiptsSection {
        position: relative !important;
        z-index: 2000 !important;
    }
    
    /* Force display for sections when needed */
    #pendingQCSection:not([style*="display: none"]), 
    #releaseQueueSection:not([style*="display: none"]), 
    #approvedSection:not([style*="display: none"]), 
    #dispensingSection:not([style*="display: none"]), 
    #recentReleasesSection:not([style*="display: none"]), 
    #recentReceiptsSection:not([style*="display: none"]) {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    /* Additional visibility overrides */
    body.section-view-active #storeTabsContent,
    body.section-view-active #storeTabs,
    body.section-view-active .tab-content,
    body.section-view-active .nav-tabs {
        display: none !important;
    }
    
    /* Ensure section content is visible */
    body.section-view-active #releaseQueueSection,
    body.section-view-active #pendingQCSection,
    body.section-view-active #approvedSection,
    body.section-view-active #dispensingSection,
    body.section-view-active #recentReleasesSection,
    body.section-view-active #recentReceiptsSection {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        z-index: 3000 !important;
    }
    
    /* Active sidebar item highlighting */
    .list-group-item.active {
        background-color: #f8f9fa;
        border-color: #0d6efd;
        border-left: 4px solid #0d6efd;
        color: #0d6efd;
        font-weight: bold;
    }
    
    /* Section container styling */
    .section-container {
        width: 100%;
        margin-bottom: 20px;
    }
    
    /* Fix for cards inside section containers */
    .section-container .card {
        width: 100%;
        display: block !important;
    }
</style>
{% endblock %}

{% block content %}
<!-- Fix URLs for API calls -->
<script>
// Set up CSRF token for AJAX requests
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Set up CSRF token header for all AJAX requests
const csrftoken = getCookie('csrftoken');
$.ajaxSetup({
    beforeSend: function(xhr, settings) {
        if (!(/^(GET|HEAD|OPTIONS|TRACE)$/.test(settings.type)) && !this.crossDomain) {
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
        }
    }
});

// Intercept fetch calls to fix URLs with underscores
const originalFetch = window.fetch;
window.fetch = function() {
    // Convert the first argument (URL) if it's a string
    if (typeof arguments[0] === 'string') {
        // Replace raw_materials with raw-materials in API calls
        arguments[0] = arguments[0].replace('/raw_materials/api/', '/raw-materials/api/');
    }
    return originalFetch.apply(this, arguments);
};

// Also intercept jQuery ajax calls
if (window.jQuery) {
    const originalAjax = jQuery.ajax;
    jQuery.ajax = function(options) {
        if (typeof options.url === 'string') {
            options.url = options.url.replace('/raw_materials/api/', '/raw-materials/api/');
        }
        return originalAjax.call(this, options);
    };
}
</script>

<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="text-primary mb-0">
                        <i class="fas fa-warehouse me-2"></i>Store Manager Dashboard
                    </h2>
                    <p class="text-muted mb-0">Raw Material Release Management</p>
                </div>
                <div class="text-end">
                    <small class="text-muted">Welcome, {{ user.get_full_name|default:user.username }}</small><br>
                    <small class="text-success">{{ user.get_role_display }}</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <a href="?filter=pending" class="text-decoration-none">
                <div class="card bg-warning text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="card-title mb-0">{{ stats.pending_phases }}</h5>
                                <p class="card-text">Pending Releases</p>
                            </div>
                            <i class="fas fa-clock fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-3">
            <a href="?filter=in_progress" class="text-decoration-none">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="card-title mb-0">{{ stats.in_progress_phases }}</h5>
                                <p class="card-text">In Progress</p>
                            </div>
                            <i class="fas fa-box fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-3">
            <a href="?filter=completed_today" class="text-decoration-none">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="card-title mb-0">{{ stats.completed_today }}</h5>
                                <p class="card-text">Completed Today</p>
                            </div>
                            <i class="fas fa-check-circle fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-3">
            <a href="?filter=total_batches" class="text-decoration-none">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="card-title mb-0">{{ stats.total_batches }}</h5>
                                <p class="card-text">Total Batches</p>
                            </div>
                            <i class="fas fa-clipboard-check fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </a>
        </div>
    </div>
    


    <!-- Navigation Tabs -->
    <ul class="nav nav-tabs mb-4" id="storeTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="releases-tab" data-bs-toggle="tab" data-bs-target="#releases" type="button" role="tab" aria-controls="releases" aria-selected="true">
                <i class="fas fa-box-open me-2"></i>Material Releases
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="inventory-tab" data-bs-toggle="tab" data-bs-target="#inventory" type="button" role="tab" aria-controls="inventory" aria-selected="false">
                <i class="fas fa-boxes me-2"></i>Inventory
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="add-material-tab" data-bs-toggle="tab" data-bs-target="#add-material" type="button" role="tab" aria-controls="add-material" aria-selected="false">
                <i class="fas fa-plus-circle me-2"></i>Add New Raw Material
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="receive-batch-tab" data-bs-toggle="tab" data-bs-target="#receive-batch" type="button" role="tab" aria-controls="receive-batch" aria-selected="false">
                <i class="fas fa-truck-loading me-2"></i>Receive Raw Material Batch
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="expiry-tab" data-bs-toggle="tab" data-bs-target="#expiry" type="button" role="tab" aria-controls="expiry" aria-selected="false">
                <i class="fas fa-calendar-times me-2"></i>Expiry Tracking
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab" aria-controls="history" aria-selected="false">
                <i class="fas fa-history me-2"></i>Recent Activity
            </button>
        </li>
    </ul>



    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3">
            <!-- Material Status Card -->
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-boxes me-2"></i>Material Status</h5>
                </div>
                <div class="list-group list-group-flush">
                    <a href="javascript:void(0);" onclick="loadSectionByName('release_queue'); return false;" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-warehouse me-2 text-primary"></i>Release Queue
                        </div>
                        <span class="badge bg-primary rounded-pill">{{ stats.pending_releases_count }}</span>
                    </a>
                    <a href="javascript:void(0);" onclick="loadSectionByName('pending_qc'); return false;" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-flask me-2 text-secondary"></i>Pending QC
                        </div>
                        <span class="badge bg-secondary rounded-pill">{{ stats.pending_qc_count }}</span>
                    </a>
                    <a href="javascript:void(0);" onclick="loadSectionByName('approved'); return false;" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-check-double me-2 text-success"></i>Approved Batches
                        </div>
                        <span class="badge bg-success rounded-pill">{{ stats.approved_count }}</span>
                    </a>
                    <a href="javascript:void(0);" onclick="loadSectionByName('dispensing'); return false;" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-weight me-2 text-info"></i>Pending Dispensing
                        </div>
                        <span class="badge bg-info rounded-pill">{{ pending_dispensing }}</span>
                    </a>
                    <a href="javascript:void(0);" onclick="loadSectionByName('recent_releases'); return false;" class="list-group-item list-group-item-action">
                        <div>
                            <i class="fas fa-history me-2 text-purple"></i>Recent Releases
                        </div>
                    </a>
                    <a href="javascript:void(0);" onclick="loadSectionByName('recent_receipts'); return false;" class="list-group-item list-group-item-action">
                        <div>
                            <i class="fas fa-truck-loading me-2 text-teal"></i>Recent Receipts
                        </div>
                    </a>
                </div>
            </div>
            
            <!-- Quick Filters -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Quick Filters</h5>
                </div>
                <div class="list-group list-group-flush">
                    <a href="javascript:void(0);" onclick="applyFilter('pending'); return false;" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-clock me-2 text-warning"></i>Pending Releases
                        </div>
                        <span class="badge bg-warning rounded-pill">{{ stats.pending_phases }}</span>
                    </a>
                    <a href="javascript:void(0);" onclick="applyFilter('in_progress'); return false;" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-box me-2 text-info"></i>In Progress
                        </div>
                        <span class="badge bg-info rounded-pill">{{ stats.in_progress_phases }}</span>
                    </a>
                    <a href="javascript:void(0);" onclick="applyFilter('completed_today'); return false;" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-check-circle me-2 text-success"></i>Completed Today
                        </div>
                        <span class="badge bg-success rounded-pill">{{ stats.completed_today }}</span>
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="col-md-9">
            <!-- Section containers for sidebar navigation items - Enhanced for visibility -->
            <div id="releaseQueueSection" class="section-container" style="display:none; position: relative; z-index: 2000;"></div>
            <div id="pendingQCSection" class="section-container" style="display:none; position: relative; z-index: 2000;"></div>
            <div id="approvedSection" class="section-container" style="display:none; position: relative; z-index: 2000;"></div>
            <div id="dispensingSection" class="section-container" style="display:none; position: relative; z-index: 2000;"></div>
            <div id="inventorySection" class="section-container" style="display:none; position: relative; z-index: 2000;"></div>
            <div id="expirySection" class="section-container" style="display:none; position: relative; z-index: 2000;"></div>
            <div id="recentReleasesSection" class="section-container" style="display:none; position: relative; z-index: 2000;"></div>
            <div id="recentReceiptsSection" class="section-container" style="display:none; position: relative; z-index: 2000;"></div>

            <!-- Tab Content -->
            <div class="tab-content" id="storeTabsContent">
                <!-- Material Releases Tab -->
                <div class="tab-pane fade show active" id="releases" role="tabpanel" aria-labelledby="releases-tab">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-box-open me-2"></i>Material Releases Dashboard
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i> Please select an option from the sidebar to view specific material release information.
                            </div>
                    {% if my_phases %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>BMR Number</th>
                                        <th>Product</th>
                                        <th>Batch Size</th>
                                        <th>Priority</th>
                                        <th>Created</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for phase in my_phases %}
                                    <tr>
                                        <td><strong class="text-primary">{{ phase.bmr.bmr_number }}</strong></td>
                                        <td>{{ phase.bmr.product.product_name }}</td>
                                        <td>{{ phase.bmr.batch_size|floatformat:0 }} {{ phase.bmr.product.unit_of_measure }}</td>
                                        <td>
                                            {% if phase.bmr.created_date|timesince|slice:":1" == "0" %}
                                                <span class="badge bg-danger">Urgent</span>
                                            {% elif phase.bmr.created_date|timesince|slice:":1" == "1" %}
                                                <span class="badge bg-warning">High</span>
                                            {% else %}
                                                <span class="badge bg-success">Normal</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ phase.bmr.created_date|date:"M d, H:i" }}</td>
                                        <td>
                                            {% if phase.status == 'pending' %}
                                                <span class="badge bg-warning">Pending</span>
                                            {% elif phase.status == 'in_progress' %}
                                                <span class="badge bg-info">In Progress</span>
                                            {% else %}
                                                <span class="badge bg-success">{{ phase.status|title }}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <a href="{% url 'bmr:detail' phase.bmr.pk %}" 
                                                   class="btn btn-outline-primary btn-sm">
                                                    <i class="fas fa-eye"></i> View
                                                </a>
                                                {% if phase.status == 'pending' %}
                                                <button class="btn btn-outline-success btn-sm"
                                                        onclick="startRelease('{{ phase.bmr.pk }}', '{{ phase.bmr.bmr_number }}')">
                                                    <i class="fas fa-play"></i> Start
                                                </button>
                                                {% elif phase.status == 'in_progress' %}
                                                <button class="btn btn-outline-warning btn-sm"
                                                        onclick="completeRelease('{{ phase.bmr.pk }}', '{{ phase.bmr.bmr_number }}')">
                                                    <i class="fas fa-check"></i> Complete
                                                </button>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-warehouse fa-3x text-success mb-3"></i>
                            <h5 class="text-muted">No Pending Raw Material Releases</h5>
                            <p class="text-muted">All raw material release requests are up to date.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Inventory Tab -->
        <div class="tab-pane fade" id="inventory" role="tabpanel" aria-labelledby="inventory-tab">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-boxes me-2"></i>Raw Materials Inventory
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Inventory Search and Filter -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="input-group">
                                <input type="text" id="inventorySearch" class="form-control" placeholder="Search materials...">
                                <button class="btn btn-outline-primary" type="button" onclick="searchInventory()">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <select id="categoryFilter" class="form-select" onchange="filterInventory()">
                                <option value="">All Categories</option>
                                <option value="active">Active Ingredients</option>
                                <option value="excipient">Excipients</option>
                                <option value="packaging">Packaging Materials</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select id="statusFilter" class="form-select" onchange="filterInventory()">
                                <option value="">All Statuses</option>
                                <option value="in_stock">In Stock</option>
                                <option value="low_stock">Low Stock</option>
                                <option value="out_of_stock">Out of Stock</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Inventory View Toggle -->
                    <div class="d-flex justify-content-end mb-2">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-sm btn-outline-primary active" id="view-by-material-btn">
                                <i class="fas fa-th-list me-1"></i>View by Material
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-primary" id="view-by-product-btn">
                                <i class="fas fa-pills me-1"></i>View by Product
                            </button>
                        </div>
                    </div>
                    
                    <!-- Materials View -->
                    <div id="materials-inventory-view">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="inventoryTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Material Code</th>
                                        <th>Material Name</th>
                                        <th>Type</th>
                                        <th>Quantity</th>
                                        <th>Units</th>
                                        <th>Reorder Level</th>
                                        <th>Status</th>
                                        <th>Associated Products</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="inventoryTableBody">
                                    <!-- Will be populated via AJAX -->
                                    <tr>
                                        <td colspan="9" class="text-center">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Products View (initially hidden) -->
                    <div id="products-inventory-view" style="display: none;">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="productInventoryTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Product</th>
                                        <th>Type</th>
                                        <th>Materials Status</th>
                                        <th>Pending QC</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="productInventoryTableBody">
                                    <tr>
                                        <td colspan="5" class="text-center">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Add New Raw Material Tab -->
        <div class="tab-pane fade" id="add-material" role="tabpanel" aria-labelledby="add-material-tab">
            <div class="card mt-2">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-plus-circle me-2"></i>Add New Raw Material
                    </h5>
                </div>
                <div class="card-body">
                    <form id="newMaterialForm" method="post">
                        {% csrf_token %}
                        <input type="hidden" name="form_type" value="new_material">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="material_name" class="form-label">Material Name</label>
                                <input type="text" name="material_name" id="material_name" class="form-control" required>
                            </div>
                            <div class="col-md-6">
                                <label for="material_type" class="form-label">Material Type</label>
                                <select name="material_type" id="material_type" class="form-select" required>
                                    <option value="">Select Type</option>
                                    <option value="active">Active Ingredient</option>
                                    <option value="excipient">Excipient</option>
                                    <option value="packaging">Packaging Material</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="unit_of_measure" class="form-label">Unit of Measure</label>
                                <select name="unit_of_measure" id="unit_of_measure" class="form-select" required>
                                    <option value="">Select Unit</option>
                                    <option value="kg">Kilograms (kg)</option>
                                    <option value="g">Grams (g)</option>
                                    <option value="l">Liters (L)</option>
                                    <option value="ml">Units (U)</option>
                                    <option value="pcs">Pieces (pcs)</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="initial_quantity" class="form-label">Initial Quantity</label>
                                <input type="number" name="initial_quantity" id="initial_quantity" class="form-control" min="0" step="0.01" required>
                            </div>
                            <div class="col-md-4">
                                <label for="reorder_level" class="form-label">Reorder Level</label>
                                <input type="number" name="reorder_level" id="reorder_level" class="form-control" min="0" step="0.01" required>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label for="associated_products" class="form-label">Product Association</label>
                                <div class="border rounded p-3">
                                    <p class="text-muted small mb-2">Select products that use this raw material:</p>
                                    <select id="associated_products" name="associated_products" class="form-select" multiple required>
                                        <!-- Will be populated via AJAX -->
                                    </select>
                                    <small class="text-muted">Hold Ctrl (Windows) or Command (Mac) to select multiple products.</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label class="form-label">Supplier Information</label>
                                <textarea name="supplier_info" class="form-control" rows="2"></textarea>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label class="form-label">Additional Notes</label>
                                <textarea name="notes" class="form-control" rows="2"></textarea>
                            </div>
                        </div>
                        
                        <div class="text-end">
                            <button type="reset" class="btn btn-outline-secondary">
                                <i class="fas fa-undo me-2"></i>Reset
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>Save New Material
                            </button>
                        </div>
                    </form>
                    
                    <div id="newMaterialSuccess" class="alert alert-success mt-3 d-none">
                        <i class="fas fa-check-circle me-2"></i>Raw material added successfully!
                        <button class="btn btn-sm btn-outline-success float-end" onclick="resetNewMaterialForm()">
                            <i class="fas fa-plus me-1"></i>Add Another Raw Material
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Receive Raw Material Batch Tab -->
        <div class="tab-pane fade" id="receive-batch" role="tabpanel" aria-labelledby="receive-batch-tab">
            <div class="card mt-2">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-truck-loading me-2"></i>Receive Raw Material Batch
                    </h5>
                </div>
                <div class="card-body">
                    <form id="receiveMaterialForm" method="post">
                        {% csrf_token %}
                        <input type="hidden" name="form_type" value="receive_material">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="material_selector" class="form-label">Select Raw Material</label>
                                <select name="material_id" class="form-select" required id="material_selector">
                                    <option value="">Select Material</option>
                                    <!-- Will be populated via AJAX -->
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="batch_number" class="form-label">Batch Number</label>
                                <input type="text" name="batch_number" id="batch_number" class="form-control" placeholder="Supplier's batch number" required>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="received_quantity" class="form-label">Received Quantity</label>
                                <input type="number" name="received_quantity" id="received_quantity" class="form-control" min="0.01" step="0.01" required>
                            </div>
                            <div class="col-md-4">
                                <label for="unit_display" class="form-label">Unit of Measure</label>
                                <input type="text" id="unit_display" class="form-control" readonly>
                                <input type="hidden" name="unit_of_measure" id="unit_hidden">
                            </div>
                            <div class="col-md-4">
                                <label for="delivery_date" class="form-label">Delivery Date</label>
                                <input type="date" name="delivery_date" id="delivery_date" class="form-control" value="{{ today|date:'Y-m-d' }}" required>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="manufacturing_date" class="form-label">Manufacturing Date</label>
                                <input type="date" name="manufacturing_date" id="manufacturing_date" class="form-control" required>
                            </div>
                            <div class="col-md-6">
                                <label for="expiry_date" class="form-label">Expiry Date</label>
                                <input type="date" name="expiry_date" id="expiry_date" class="form-control" required>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label for="supplier_info_display" class="form-label">Supplier Information</label>
                                <textarea name="supplier_info" class="form-control" rows="2" id="supplier_info_display" readonly></textarea>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label for="receiving_notes" class="form-label">Receiving Notes</label>
                                <textarea name="receiving_notes" id="receiving_notes" class="form-control" rows="2"></textarea>
                            </div>
                        </div>
                        
                        <div class="text-end">
                            <button type="reset" class="btn btn-outline-secondary">
                                <i class="fas fa-undo me-2"></i>Reset
                            </button>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-truck-loading me-2"></i>Record Received Batch
                            </button>
                        </div>
                    </form>
                    
                    <div id="receiveMaterialSuccess" class="alert alert-success mt-3 d-none">
                        <i class="fas fa-check-circle me-2"></i>Raw material batch received successfully!
                        <button class="btn btn-sm btn-outline-success float-end" onclick="resetReceiveMaterialForm()">
                            <i class="fas fa-plus me-1"></i>Receive Another Batch
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Expiry Tracking Tab -->
        <div class="tab-pane fade" id="expiry" role="tabpanel" aria-labelledby="expiry-tab">
            <div class="card">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-calendar-times me-2"></i>Expiry Tracking
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="expiryTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>Material</th>
                                    <th>Batch Number</th>
                                    <th>Quantity Left</th>
                                    <th>Expiry Date</th>
                                    <th>Days Left</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="expiryTableBody">
                                <!-- Will be populated via AJAX -->
                                <tr>
                                    <td colspan="6" class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Recent Activity Tab -->
        <div class="tab-pane fade" id="history" role="tabpanel" aria-labelledby="history-tab">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-history me-2"></i>Recent Activity
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Date</th>
                                    <th>Action</th>
                                    <th>Material</th>
                                    <th>Batch</th>
                                    <th>Quantity</th>
                                    <th>User</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for action in recent_activity %}
                                <tr>
                                    <td>{{ action.timestamp|date:"M d, H:i" }}</td>
                                    <td>
                                        {% if action.action_type == 'receive' %}
                                            <span class="badge bg-success">Received</span>
                                        {% elif action.action_type == 'issue' %}
                                            <span class="badge bg-warning">Issued</span>
                                        {% elif action.action_type == 'add' %}
                                            <span class="badge bg-primary">Added</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ action.action_type|title }}</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ action.material.material_name }}</td>
                                    <td>
                                        {% if action.batch_number %}
                                            {{ action.batch_number }}
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if action.action_type == 'receive' %}
                                            <span class="text-success">+{{ action.quantity }} {{ action.material.unit_of_measure }}</span>
                                        {% elif action.action_type == 'issue' %}
                                            <span class="text-danger">-{{ action.quantity }} {{ action.material.unit_of_measure }}</span>
                                        {% else %}
                                            {{ action.quantity }} {{ action.material.unit_of_measure }}
                                        {% endif %}
                                    </td>
                                    <td>{{ action.user.username }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted py-3">No recent activity recorded</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Dashboard Footer -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <p class="text-muted text-center mb-0">
                        <small>Use the sidebar navigation to access all material management features.</small>
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Section containers moved to the main content area -->
{% endblock %}

{% block extra_js %}
<script>
    // Load inventory data when page loads
    $(document).ready(function() {
        loadInventoryData();
        loadExpiryData();
        loadMaterialsList();
        loadProductsList();
        
        // Form submission for new material
        $('#newMaterialForm').submit(function(e) {
            e.preventDefault();
            $.ajax({
                type: 'POST',
                url: '{% url 'raw_materials:add_material' %}',
                data: $(this).serialize(),
                success: function(response) {
                    if(response.status === 'success') {
                        $('#newMaterialSuccess').removeClass('d-none');
                        loadInventoryData(); // Refresh inventory
                        loadMaterialsList(); // Refresh materials dropdown
                    } else {
                        alert('Error: ' + response.message);
                    }
                }
            });
        });
        
        // Form submission for receiving material
        $('#receiveMaterialForm').submit(function(e) {
            e.preventDefault();
            $.ajax({
                type: 'POST',
                url: '{% url 'raw_materials:receive_material' %}',
                data: $(this).serialize(),
                success: function(response) {
                    if(response.status === 'success') {
                        $('#receiveMaterialSuccess').removeClass('d-none');
                        loadInventoryData(); // Refresh inventory
                        loadExpiryData();   // Refresh expiry data
                    } else {
                        alert('Error: ' + response.message);
                    }
                }
            });
        });
        
        // Material selector change event
        $('#material_selector').change(function() {
            var materialId = $(this).val();
            if(materialId) {
                console.log("Material selected:", materialId);
                $('#unit_display').val('Loading...');
                $('#supplier_info_display').val('Loading...');
                
                $.ajax({
                    type: 'GET',
                    url: '{% url 'raw_materials:api_material_detail' %}',
                    data: {
                        'material_id': materialId
                    },
                    dataType: 'json',
                    success: function(data) {
                        console.log("Material details received:", data);
                        if (data && data.material) {
                            $('#unit_display').val(data.material.unit_of_measure);
                            $('#unit_hidden').val(data.material.unit_of_measure);
                            $('#supplier_info_display').val(data.material.default_supplier || 'No supplier information available');
                        } else {
                            console.error("Invalid material details response:", data);
                            $('#unit_display').val('Error loading details');
                            $('#supplier_info_display').val('Error loading details');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error("Error loading material details:", error);
                        console.error("Status:", status);
                        console.error("Response:", xhr.responseText);
                        $('#unit_display').val('Error: ' + error);
                        $('#supplier_info_display').val('Error loading details');
                    }
                });
            } else {
                $('#unit_display').val('');
                $('#unit_hidden').val('');
                $('#supplier_info_display').val('');
            }
        });
    });
    
    // Load inventory data via AJAX
    function loadInventoryData() {
        console.log("Loading inventory data...");
        
        // Show loading indicator
        var tableBody = $('#inventoryTableBody');
        tableBody.html(`
            <tr>
                <td colspan="9" class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading inventory data...</p>
                </td>
            </tr>
        `);
        
        $.ajax({
            type: 'GET',
            url: '{% url 'raw_materials:api_materials' %}',
            dataType: 'json',
            success: function(data) {
                console.log("Inventory data received:", data);
                if (data && data.materials) {
                    populateInventoryTable(data.materials);
                } else {
                    console.error("Invalid data format received:", data);
                    tableBody.html(`
                        <tr>
                            <td colspan="9" class="text-center text-warning py-3">
                                <i class="fas fa-exclamation-circle me-2"></i>No inventory data available or invalid response format.
                                <button class="btn btn-sm btn-outline-primary ms-3" onclick="loadInventoryData()">
                                    <i class="fas fa-sync-alt me-1"></i>Retry
                                </button>
                            </td>
                        </tr>
                    `);
                }
            },
            error: function(xhr, status, error) {
                console.error("Error loading inventory data:", error);
                console.error("Status:", status);
                console.error("Response:", xhr.responseText);
                tableBody.html(`
                    <tr>
                        <td colspan="9" class="text-center text-danger py-3">
                            <i class="fas fa-exclamation-triangle me-2"></i>Failed to load inventory data. 
                            Error: ${error}
                            <button class="btn btn-sm btn-outline-primary ms-3" onclick="loadInventoryData()">
                                <i class="fas fa-sync-alt me-1"></i>Retry
                            </button>
                        </td>
                    </tr>
                `);
            }
        });
    }
    
    // Populate inventory table with data
    function populateInventoryTable(materials) {
        var tableBody = $('#inventoryTableBody');
        tableBody.empty();
        
        if (materials && materials.length > 0) {
            materials.forEach(function(material) {
                var statusClass = material.status === 'in_stock' ? 'bg-success' : 
                                 (material.status === 'low_stock' ? 'bg-warning' : 'bg-danger');
                var statusText = material.status === 'in_stock' ? 'In Stock' : 
                               (material.status === 'low_stock' ? 'Low Stock' : 'Out of Stock');
                
                // Get associated products
                let productsDisplay = '<span class="text-muted">None</span>';
                if (material.products && material.products.length > 0) {
                    productsDisplay = material.products.map(product => 
                        `<span class="badge bg-secondary me-1 mb-1">${product}</span>`
                    ).join('');
                }
                
                // Calculate how many approved batches are available
                let approvedBatchesText = '';
                if (material.pending_qc_batches > 0) {
                    approvedBatchesText = `<span class="badge bg-warning text-dark me-1" title="Pending QC">${material.pending_qc_batches} pending QC</span>`;
                }
                
                tableBody.append(`
                    <tr>
                        <td><strong>${material.material_code}</strong></td>
                        <td>
                            ${material.material_name}
                            ${approvedBatchesText}
                        </td>
                        <td>${material.category_display}</td>
                        <td class="text-end fw-bold">${parseFloat(material.current_stock).toFixed(2)}</td>
                        <td>${material.unit_of_measure}</td>
                        <td class="text-end">${parseFloat(material.reorder_level).toFixed(2)}</td>
                        <td><span class="badge ${statusClass}">${statusText}</span></td>
                        <td class="product-tags">${productsDisplay}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-info" onclick="viewMaterialDetails(${material.id})" title="View Details">
                                <i class="fas fa-info-circle"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-primary ms-1" onclick="viewMaterialBatches(${material.id})" title="View Batches">
                                <i class="fas fa-layer-group"></i>
                            </button>
                        </td>
                    </tr>
                `);
            });
        } else {
            tableBody.append(`
                <tr>
                    <td colspan="7" class="text-center text-muted py-3">No materials found</td>
                </tr>
            `);
        }
    }
    
    // Search inventory
    function searchInventory() {
        var searchTerm = $('#inventorySearch').val().toLowerCase();
        var categoryFilter = $('#categoryFilter').val();
        var statusFilter = $('#statusFilter').val();
        
        $('#inventoryTable tbody tr').each(function() {
            var row = $(this);
            var materialName = row.find('td:first').text().toLowerCase();
            var materialType = row.find('td:nth-child(2)').text().toLowerCase();
            var materialStatus = row.find('td:nth-child(6)').text().toLowerCase();
            
            var nameMatch = materialName.indexOf(searchTerm) > -1;
            var categoryMatch = categoryFilter === '' || materialType.indexOf(categoryFilter) > -1;
            var statusMatch = statusFilter === '' || materialStatus.indexOf(statusFilter.replace('_', ' ')) > -1;
            
            if (nameMatch && categoryMatch && statusMatch) {
                row.show();
            } else {
                row.hide();
            }
        });
    }
    
    // Filter inventory
    function filterInventory() {
        searchInventory();
    }
    
    // Load expiry tracking data
    function loadExpiryData() {
        console.log("Loading expiry data...");
        
        // Show loading indicator
        var tableBody = $('#expiryTableBody');
        tableBody.html(`
            <tr>
                <td colspan="6" class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading expiry data...</p>
                </td>
            </tr>
        `);
        
        $.ajax({
            type: 'GET',
            url: '{% url 'raw_materials:api_expiry' %}',
            dataType: 'json',
            success: function(data) {
                console.log("Expiry data received:", data);
                tableBody.empty();
                
                if (data.batches && data.batches.length > 0) {
                    data.batches.forEach(function(batch) {
                        var statusClass = batch.days_left > 90 ? 'bg-success' : 
                                         (batch.days_left > 30 ? 'bg-warning' : 'bg-danger');
                        var statusText = batch.days_left > 90 ? 'OK' : 
                                       (batch.days_left > 30 ? 'Expiring Soon' : 'Critical');
                        
                        tableBody.append(`
                            <tr>
                                <td>${batch.material_name}</td>
                                <td>${batch.batch_number}</td>
                                <td>${batch.quantity_left} ${batch.unit_of_measure}</td>
                                <td>${batch.expiry_date}</td>
                                <td>${batch.days_left}</td>
                                <td><span class="badge ${statusClass}">${statusText}</span></td>
                            </tr>
                        `);
                    });
                } else {
                    tableBody.append(`
                        <tr>
                            <td colspan="6" class="text-center text-muted py-3">No batches found</td>
                        </tr>
                    `);
                }
            },
            error: function(xhr, status, error) {
                console.error("Error loading expiry data:", error);
                console.error("Status:", status);
                console.error("Response:", xhr.responseText);
                tableBody.html(`
                    <tr>
                        <td colspan="6" class="text-center text-danger py-3">
                            <i class="fas fa-exclamation-triangle me-2"></i>Failed to load expiry data. 
                            Error: ${error}
                            <button class="btn btn-sm btn-outline-primary ms-3" onclick="loadExpiryData()">
                                <i class="fas fa-sync-alt me-1"></i>Retry
                            </button>
                        </td>
                    </tr>
                `);
            }
        });
    }
    
    // Load materials for dropdown
    function loadMaterialsList() {
        console.log("Loading materials list...");
        var selector = $('#material_selector');
        
        // Show loading indicator in dropdown
        selector.find('option:not(:first)').remove();
        selector.append('<option disabled>Loading materials...</option>');
        
        $.ajax({
            type: 'GET',
            url: '{% url 'raw_materials:api_materials' %}',
            dataType: 'json',
            success: function(data) {
                console.log("Materials list received:", data);
                selector.find('option:not(:first)').remove();
                
                if (data.materials && data.materials.length > 0) {
                    data.materials.forEach(function(material) {
                        var displayName = material.material_name;
                        var displayType = material.material_type_display || material.category_display || "Unknown Type";
                        selector.append(`
                            <option value="${material.id}">${displayName} (${displayType})</option>
                        `);
                    });
                    console.log(`Loaded ${data.materials.length} materials into dropdown`);
                } else {
                    selector.append('<option disabled>No materials found</option>');
                    console.warn("No materials returned from server");
                    console.warn("Response data:", data);
                }
            },
            error: function(xhr, status, error) {
                console.error("Error loading materials list:", error);
                console.error("Status:", status);
                console.error("Response:", xhr.responseText);
                selector.find('option:not(:first)').remove();
                selector.append(`<option disabled class="text-danger">Error loading materials: ${error}</option>`);
            }
        });
    }
    
    // Load products for multi-select
    function loadProductsList() {
        console.log("Starting loadProductsList function");
        // Add loading indicator
        var selector = $('#associated_products');
        selector.empty();
        selector.append('<option disabled>Loading products...</option>');
        
        $.ajax({
            type: 'GET',
            url: "{% url 'products:ajax_products_list' %}",
            success: function(data) {
                selector.empty();
                
                console.log("Product data received:", data); // Debug output
                
                if (data.products && data.products.length > 0) {
                    data.products.forEach(function(product) {
                        selector.append(`
                            <option value="${product.id}">${product.product_name} (${product.category})</option>
                        `);
                    });
                    console.log(`Loaded ${data.products.length} products into dropdown`); // Debug output
                } else {
                    selector.append(`
                        <option value="" disabled>No products available</option>
                    `);
                    console.log("No products found in response"); // Debug output
                    
                    // Create a default product option if none are available
                    selector.append(`
                        <option value="default">Sample Product (For Testing)</option>
                    `);
                }
            },
            error: function(xhr, status, error) {
                console.error("Error loading products:", error);
                var selector = $('#associated_products');
                selector.empty();
                selector.append(`
                    <option value="" disabled>Error loading products</option>
                `);
            }
        });
    }
    
    // Start a material release
    function startRelease(bmrId, bmrNumber) {
        if(confirm(`Start raw material release for BMR #${bmrNumber}?`)) {
            $.ajax({
                type: 'POST',
                url: "{% url 'bmr:start_phase' bmrId 'material_release' %}",
                data: {
                    'action': 'start',
                    'bmr_id': bmrId,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function(response) {
                    if(response.status === 'success') {
                        location.reload();
                    } else {
                        alert('Error: ' + response.message);
                    }
                }
            });
        }
    }
    
    // Complete a material release
    function completeRelease(bmrId, bmrNumber) {
        if(confirm(`Complete raw material release for BMR #${bmrNumber}?`)) {
            $.ajax({
                type: 'POST',
                url: "{% url 'bmr:complete_phase' bmrId 'material_release' %}",
                data: {
                    'action': 'complete',
                    'bmr_id': bmrId,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function(response) {
                    if(response.status === 'success') {
                        location.reload();
                    } else {
                        alert('Error: ' + response.message);
                    }
                }
            });
        }
    }
    
    // Reset new material form after successful submission
    function resetNewMaterialForm() {
        $('#newMaterialForm')[0].reset();
        $('#newMaterialSuccess').addClass('d-none');
    }
    
    // Reset receive material form after successful submission
    function resetReceiveMaterialForm() {
        $('#receiveMaterialForm')[0].reset();
        $('#receiveMaterialSuccess').addClass('d-none');
    }
    
    // View material details modal
    function viewMaterialDetails(materialId) {
        // Fetch material details
        $.ajax({
            url: `/raw-materials/api/materials/?material_id=${materialId}`,
            method: 'GET',
            success: function(data) {
                if (data.success) {
                    // Create a modal with detailed material information
                    let material = data.material;
                    const modalContent = `
                    <div class="modal fade" id="materialDetailsModal" tabindex="-1" aria-hidden="true">
                      <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                          <div class="modal-header bg-info text-white">
                            <h5 class="modal-title"><i class="fas fa-box me-2"></i>${material.material_name}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                          </div>
                          <div class="modal-body">
                            <div class="row mb-3">
                              <div class="col-md-6">
                                <h6>Material Information</h6>
                                <table class="table table-sm table-bordered">
                                  <tr>
                                    <th>Material Code</th>
                                    <td>${material.material_code}</td>
                                  </tr>
                                  <tr>
                                    <th>Category</th>
                                    <td>${material.category_display}</td>
                                  </tr>
                                  <tr>
                                    <th>Unit</th>
                                    <td>${material.unit_of_measure}</td>
                                  </tr>
                                  <tr>
                                    <th>Current Stock</th>
                                    <td><strong>${parseFloat(material.current_stock).toFixed(2)} ${material.unit_of_measure}</strong></td>
                                  </tr>
                                  <tr>
                                    <th>Reorder Level</th>
                                    <td>${parseFloat(material.reorder_level).toFixed(2)} ${material.unit_of_measure}</td>
                                  </tr>
                                  <tr>
                                    <th>Default Supplier</th>
                                    <td>${material.default_supplier || 'Not specified'}</td>
                                  </tr>
                                </table>
                              </div>
                              <div class="col-md-6">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                  <h6>Associated Products</h6>
                                  <button type="button" class="btn btn-sm btn-primary" onclick="editProductAssociations(${material.id})">
                                    <i class="fas fa-edit me-1"></i> Edit Associations
                                  </button>
                                </div>
                                <div class="associated-products p-2 border rounded">
                                  ${material.products && material.products.length > 0 ? 
                                    material.products.map(product => 
                                      `<span class="badge bg-secondary me-1 mb-1 p-2">${product}</span>`
                                    ).join('') : 
                                    '<span class="text-muted">No associated products</span>'}
                                </div>
                              </div>
                            </div>
                          </div>
                          <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                          </div>
                        </div>
                      </div>
                    </div>`;
                    
                    // Remove existing modal if any
                    $('#materialDetailsModal').remove();
                    
                    // Add modal to body and show it
                    $('body').append(modalContent);
                    $('#materialDetailsModal').modal('show');
                } else {
                    alert('Error loading material details: ' + data.error);
                }
            },
            error: function() {
                alert('Error loading material details');
            }
        });
    }
    
    function viewMaterialBatches(materialId) {
        // Fetch material batches
        $.ajax({
            url: `/raw-materials/api/batch-detail/?material_id=${materialId}`,
            method: 'GET',
            success: function(data) {
                if (data.success) {
                    // Create a modal with batch information
                    let material = data.material;
                    let batches = data.batches || [];
                    
                    // Count approved batches
                    let approvedBatches = batches.filter(b => b.status === 'approved').length;
                    let pendingBatches = batches.filter(b => b.status === 'pending_qc').length;
                    let rejectedBatches = batches.filter(b => b.status === 'rejected').length;
                    
                    let batchesHtml = '';
                    if (batches.length > 0) {
                        // Add summary of batches at the top
                        batchesHtml = `
                        <div class="d-flex flex-wrap mb-3 gap-2">
                            <div class="border rounded p-2 text-center">
                                <h6 class="mb-1">Total Batches</h6>
                                <span class="fs-4">${batches.length}</span>
                            </div>
                            <div class="border rounded p-2 text-center bg-success bg-opacity-10">
                                <h6 class="mb-1">Approved</h6>
                                <span class="fs-4">${approvedBatches}</span>
                            </div>
                            <div class="border rounded p-2 text-center bg-warning bg-opacity-10">
                                <h6 class="mb-1">Pending QC</h6>
                                <span class="fs-4">${pendingBatches}</span>
                            </div>
                            <div class="border rounded p-2 text-center bg-danger bg-opacity-10">
                                <h6 class="mb-1">Rejected</h6>
                                <span class="fs-4">${rejectedBatches}</span>
                            </div>
                        </div>
                        `;
                        
                        batchesHtml += '<table class="table table-sm table-striped"><thead><tr>' +
                                      '<th>Batch #</th><th>Supplier</th><th>Received</th><th>Expiry</th><th>Qty Remaining</th><th>Status</th></tr></thead><tbody>';
                        
                        batches.forEach(batch => {
                            const statusClass = batch.status === 'approved' ? 'success' : 
                                              (batch.status === 'pending_qc' ? 'warning' : 'danger');
                            
                            const statusDisplay = {
                                'approved': 'Approved',
                                'pending_qc': 'Pending QC',
                                'rejected': 'Rejected',
                                'expired': 'Expired',
                                'depleted': 'Depleted'
                            }[batch.status] || batch.status;
                            
                            batchesHtml += `<tr>
                                <td>${batch.batch_number}</td>
                                <td>${batch.supplier || 'N/A'}</td>
                                <td>${batch.received_date}</td>
                                <td>${batch.expiry_date}</td>
                                <td>${parseFloat(batch.quantity_remaining).toFixed(2)} ${material.unit_of_measure}</td>
                                <td><span class="badge bg-${statusClass}">${statusDisplay}</span></td>
                            </tr>`;
                        });
                        
                        batchesHtml += '</tbody></table>';
                    } else {
                        batchesHtml = '<div class="alert alert-info">No batches found for this material</div>';
                    }
                    
                    const modalContent = `
                    <div class="modal fade" id="batchesModal" tabindex="-1" aria-hidden="true">
                      <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                          <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title"><i class="fas fa-layer-group me-2"></i>Batches for ${material.material_name}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                          </div>
                          <div class="modal-body">
                            ${batchesHtml}
                          </div>
                          <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                          </div>
                        </div>
                      </div>
                    </div>`;
                    
                    // Remove existing modal if any
                    $('#batchesModal').remove();
                    
                    // Add modal to body and show it
                    $('body').append(modalContent);
                    $('#batchesModal').modal('show');
                } else {
                    alert('Error loading batches: ' + data.error);
                }
            },
            error: function() {
                alert('Error loading batches');
            }
        });
    }
    
    // Edit product associations for a material
    function editProductAssociations(materialId) {
        // Close any open material details modal
        $('#materialDetailsModal').modal('hide');
        
        // Fetch available products and current associations
        $.ajax({
            url: `/raw-materials/api/materials/?material_id=${materialId}&include_all_products=true`,
            method: 'GET',
            success: function(data) {
                if (data.success) {
                    const material = data.material;
                    const allProducts = data.all_products || [];
                    
                    // Create arrays of product IDs for easy checking
                    const associatedProductIds = material.product_ids || [];
                    
                    // Build product checkboxes HTML
                    let productsHtml = '';
                    
                    if (allProducts.length === 0) {
                        productsHtml = '<div class="alert alert-info">No products found in the system.</div>';
                    } else {
                        productsHtml = '<div class="list-group product-selection-list" style="max-height: 300px; overflow-y: auto;">';
                        
                        allProducts.forEach(product => {
                            const isChecked = associatedProductIds.includes(product.id) ? 'checked' : '';
                            
                            productsHtml += `
                            <div class="list-group-item">
                                <div class="form-check">
                                    <input class="form-check-input product-checkbox" type="checkbox" 
                                           value="${product.id}" id="product_edit_${product.id}" ${isChecked}>
                                    <label class="form-check-label" for="product_edit_${product.id}">
                                        ${product.name} (${product.type})
                                    </label>
                                </div>
                            </div>`;
                        });
                        
                        productsHtml += '</div>';
                    }
                    
                    // Build modal HTML
                    const modalHtml = `
                    <div class="modal fade" id="editAssociationsModal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header bg-primary text-white">
                                    <h5 class="modal-title">
                                        <i class="fas fa-edit me-2"></i>Edit Product Associations for ${material.material_name}
                                    </h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <p class="text-muted">Select which products use this raw material:</p>
                                    <form id="editAssociationsForm">
                                        <input type="hidden" name="material_id" value="${material.id}">
                                        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                                        
                                        <div class="mb-3">
                                            <label class="form-label d-flex justify-content-between">
                                                <span>Products</span>
                                                <span class="badge bg-primary" id="selectedCountEdit">0 selected</span>
                                            </label>
                                            ${productsHtml}
                                        </div>
                                        
                                        <div class="alert alert-success d-none" id="editAssociationsSuccess">
                                            <i class="fas fa-check-circle me-2"></i>Product associations updated successfully!
                                        </div>
                                        <div class="alert alert-danger d-none" id="editAssociationsError"></div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="button" class="btn btn-primary" onclick="saveProductAssociations()">
                                        <i class="fas fa-save me-2"></i>Save Changes
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    `;
                    
                    // Remove existing modal if any
                    $('#editAssociationsModal').remove();
                    
                    // Add modal to body and show it
                    $('body').append(modalHtml);
                    const modal = new bootstrap.Modal(document.getElementById('editAssociationsModal'));
                    modal.show();
                    
                    // Update the selected count
                    updateSelectedCount();
                    
                    // Add event listeners to checkboxes
                    $('.product-checkbox').on('change', function() {
                        updateSelectedCount();
                    });
                } else {
                    alert('Error loading material details: ' + (data.error || 'Unknown error'));
                }
            },
            error: function() {
                alert('Error loading material details. Please try again.');
            }
        });
    }
    
    // Update the selected count in the edit associations modal
    function updateSelectedCount() {
        const selectedCount = $('.product-checkbox:checked').length;
        $('#selectedCountEdit').text(selectedCount + ' selected');
    }
    
    // Save product associations
    function saveProductAssociations() {
        // Get selected product IDs
        const selectedProducts = [];
        $('.product-checkbox:checked').each(function() {
            selectedProducts.push($(this).val());
        });
        
        const materialId = $('#editAssociationsForm input[name="material_id"]').val();
        
        // Hide any previous alerts
        $('#editAssociationsSuccess').addClass('d-none');
        $('#editAssociationsError').addClass('d-none');
        
        // Send update request
        $.ajax({
            url: '/raw-materials/api/update-associations/',
            method: 'POST',
            data: {
                material_id: materialId,
                product_ids: JSON.stringify(selectedProducts),
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.success) {
                    // Show success message
                    $('#editAssociationsSuccess').removeClass('d-none');
                    
                    // Close modal after a delay and refresh the page
                    setTimeout(function() {
                        $('#editAssociationsModal').modal('hide');
                        location.reload();
                    }, 1500);
                } else {
                    // Show error message
                    $('#editAssociationsError').text(response.error || 'Unknown error occurred').removeClass('d-none');
                }
            },
            error: function() {
                $('#editAssociationsError').text('Error saving changes. Please try again.').removeClass('d-none');
            }
        });
    }
    
    // Toggle between inventory views
    $('#view-by-material-btn').on('click', function() {
        $(this).addClass('active');
        $('#view-by-product-btn').removeClass('active');
        $('#materials-inventory-view').show();
        $('#products-inventory-view').hide();
    });
    
    $('#inventory-by-material-btn').on('click', function() {
        $(this).addClass('active');
        $('#inventory-by-product-btn').removeClass('active');
        $('#inventory-materials-view').show();
        $('#inventory-products-view').hide();
    });
    
    $('#view-by-product-btn, #inventory-by-product-btn').on('click', function() {
        // Update both toggle button groups to be consistent
        $('#view-by-product-btn').addClass('active');
        $('#view-by-material-btn').removeClass('active');
        $('#inventory-by-product-btn').addClass('active');
        $('#inventory-by-material-btn').removeClass('active');
        
        // Show product views and hide material views
        $('#products-inventory-view').show();
        $('#materials-inventory-view').hide();
        $('#inventory-products-view').show();
        $('#inventory-materials-view').hide();
        
        // Load product inventory data
        loadProductInventory();
    });
    
    // Load inventory organized by product
    function loadProductInventory() {
        $('#productInventoryTableBody, #productInventoryTable').html(`
            <tr>
                <td colspan="5" class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </td>
            </tr>
        `);
        
        $.ajax({
            url: '/raw-materials/api/inventory-by-product/',
            method: 'GET',
            success: function(data) {
                if (data.success) {
                    if (data.product_inventory && data.product_inventory.length > 0) {
                        let tableContent = '';
                        
                        data.product_inventory.forEach(product => {
                            // Calculate material status
                            let materialStatus = 'Good';
                            let statusClass = 'success';
                            let lowStockCount = 0;
                            let outOfStockCount = 0;
                            let pendingQCCount = 0;
                            
                            product.materials.forEach(material => {
                                if (material.approved_quantity < material.reorder_level) {
                                    lowStockCount++;
                                    if (material.approved_quantity === 0) {
                                        outOfStockCount++;
                                    }
                                }
                                
                                if (material.pending_quantity > 0) {
                                    pendingQCCount++;
                                }
                            });
                            
                            if (outOfStockCount > 0) {
                                materialStatus = `${outOfStockCount} out of stock`;
                                statusClass = 'danger';
                            } else if (lowStockCount > 0) {
                                materialStatus = `${lowStockCount} low stock`;
                                statusClass = 'warning';
                            }
                            
                            tableContent += `
                            <tr>
                                <td>${product.product_name}</td>
                                <td>${product.product_type}</td>
                                <td>
                                    <span class="badge bg-${statusClass}">${materialStatus}</span>
                                    <span class="badge bg-primary">${product.material_count} materials</span>
                                </td>
                                <td>
                                    ${pendingQCCount > 0 ? 
                                        `<span class="badge bg-info">${pendingQCCount} materials pending QC</span>` : 
                                        `<span class="badge bg-secondary">No pending QC</span>`
                                    }
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-info" onclick="showProductMaterials(${product.id})">
                                        <i class="fas fa-list me-1"></i>Materials
                                    </button>
                                </td>
                            </tr>
                            `;
                        });
                        
                        $('#productInventoryTableBody, #productInventoryTable tbody').html(tableContent);
                    } else {
                        $('#productInventoryTableBody, #productInventoryTable tbody').html(`
                            <tr>
                                <td colspan="5" class="text-center">
                                    No products found
                                </td>
                            </tr>
                        `);
                    }
                } else {
                    $('#productInventoryTableBody, #productInventoryTable tbody').html(`
                        <tr>
                            <td colspan="5" class="text-center text-danger">
                                Error loading product inventory: ${data.error || 'Unknown error'}
                            </td>
                        </tr>
                    `);
                }
            },
            error: function() {
                $('#productInventoryTableBody, #productInventoryTable tbody').html(`
                    <tr>
                        <td colspan="5" class="text-center text-danger">
                            Failed to load product inventory. Please try again.
                        </td>
                    </tr>
                `);
            }
        });
    }
    
    // Show materials for a specific product
    function showProductMaterials(productId) {
        // Show loading
        const loadingModal = `
        <div class="modal fade" id="productMaterialsModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title"><i class="fas fa-boxes me-2"></i>Loading Materials...</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center p-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3">Loading product materials...</p>
                    </div>
                </div>
            </div>
        </div>`;
        
        // Remove any existing modal
        $('#productMaterialsModal').remove();
        
        // Add and show loading modal
        $('body').append(loadingModal);
        const modal = new bootstrap.Modal(document.getElementById('productMaterialsModal'));
        modal.show();
        
        // Fetch product materials
        $.ajax({
            url: '/raw-materials/api/inventory-by-product/',
            method: 'GET',
            data: {
                product_id: productId
            },
            success: function(data) {
                if (data.success) {
                    const product = data.product_inventory.find(p => p.id === productId);
                    
                    if (product) {
                        // Create materials table content
                        let materialsHtml = `
                        <div class="table-responsive">
                            <table class="table table-sm table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Material</th>
                                        <th>Code</th>
                                        <th>Approved Stock</th>
                                        <th>Pending QC</th>
                                        <th>Reorder Level</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>`;
                                
                        if (product.materials.length > 0) {
                            product.materials.forEach(material => {
                                const statusClass = material.status === 'low_stock' ? 'warning' : 'success';
                                materialsHtml += `
                                <tr>
                                    <td>${material.material_name}</td>
                                    <td>${material.material_code}</td>
                                    <td>${material.approved_quantity.toFixed(2)} ${material.unit_of_measure}</td>
                                    <td>${material.pending_quantity > 0 ? 
                                        `<span class="badge bg-info">${material.pending_quantity.toFixed(2)} ${material.unit_of_measure}</span>` : 
                                        '-'}
                                    </td>
                                    <td>${material.reorder_level.toFixed(2)} ${material.unit_of_measure}</td>
                                    <td>
                                        <span class="badge bg-${statusClass}">
                                            ${material.status === 'low_stock' ? 'Low Stock' : 'In Stock'}
                                        </span>
                                    </td>
                                </tr>`;
                            });
                        } else {
                            materialsHtml += `
                            <tr>
                                <td colspan="6" class="text-center">No materials associated with this product</td>
                            </tr>`;
                        }
                        
                        materialsHtml += `
                                </tbody>
                            </table>
                        </div>`;
                        
                        // Update modal content
                        $('#productMaterialsModal .modal-title').html(`<i class="fas fa-boxes me-2"></i>Materials for ${product.product_name}`);
                        $('#productMaterialsModal .modal-body').html(materialsHtml);
                        
                    } else {
                        $('#productMaterialsModal .modal-body').html(`
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Product not found or has no associated materials.
                            </div>
                        `);
                    }
                } else {
                    $('#productMaterialsModal .modal-body').html(`
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            Error: ${data.error || 'Failed to load product materials'}
                        </div>
                    `);
                }
            },
            error: function() {
                $('#productMaterialsModal .modal-body').html(`
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Failed to load product materials. Please try again.
                    </div>
                `);
            }
        });
    }
    
    // Debug panel functions
    function toggleDebugTools() {
        var debugTools = document.getElementById('debugTools');
        if (debugTools.style.display === 'none') {
            debugTools.style.display = 'block';
        } else {
            debugTools.style.display = 'none';
        }
    }
    
    // Function to load section data based on URL parameters
    function loadSectionFromUrl() {
        var urlParams = new URLSearchParams(window.location.search);
        var section = urlParams.get('section');
        var filter = urlParams.get('filter');
        
        console.log("URL parameters - Section:", section, "Filter:", filter);
        
        // Debug information
        console.log("Initial tab visibility: storeTabs=", $('#storeTabs').is(':visible'));
        console.log("Initial tab visibility: storeTabsContent=", $('#storeTabsContent').is(':visible'));
        console.log("Initial section visibility: pendingQCSection=", $('#pendingQCSection').is(':visible'));
        console.log("Initial section visibility: dispensingSection=", $('#dispensingSection').is(':visible'));
        
        // Default to tabs content if no section specified
        if (!section && !filter) {
            console.log("No section or filter specified, showing tabs content");
            // Hide section content
            $('#inventorySection, #expirySection, #pendingQCSection, #approvedSection, #dispensingSection, #recentReleasesSection, #recentReceiptsSection').hide();
            // Show tabs content and navigation
            $('#storeTabsContent').show();
            $('#storeTabs').show();
            $('.tab-pane').removeClass('show active'); // Reset all tabs
            $('#releases').addClass('show active'); // Show default tab
            loadInventoryData();
            return;
        }
        
        // If showing a specific section, hide the tabs content
        if (section) {
            console.log("Section specified:", section, "- hiding tab content");
            
            // First hide ALL content
            $('.tab-pane').removeClass('show active');
            $('#storeTabsContent').hide();
            $('#storeTabs').hide();
            $('#inventorySection, #expirySection, #pendingQCSection, #approvedSection, #dispensingSection, #recentReleasesSection, #recentReceiptsSection').hide();
            
            console.log("Elements hidden. Tab visibility now: storeTabs=", $('#storeTabs').is(':visible'));
            
            // Load the appropriate section based on URL parameter
            if (section === 'release_queue') {
                console.log("Loading release queue section from URL parameter");
                loadReleaseQueueSection();
            } else if (section === 'pending_qc') {
                console.log("Loading pending QC section from URL parameter");
                loadPendingQCSection();
            } else if (section === 'approved') {
                console.log("Loading approved section from URL parameter");
                loadApprovedSection();
            } else if (section === 'dispensing') {
                console.log("Loading dispensing section from URL parameter");
                loadDispensingSection();
            } else if (section === 'recent_releases') {
                console.log("Loading recent releases section from URL parameter");
                loadRecentReleasesSection();
            } else if (section === 'recent_receipts') {
                console.log("Loading recent receipts section from URL parameter");
                loadRecentReceiptsSection();
            } else {
                console.log("Unknown section parameter:", section);
                resetDashboard();
            }
        } else {
            // Show tabs if no specific section
            $('#storeTabsContent').show();
            $('#storeTabs').show();
        }
        
        // Handle filter parameter
        if (filter) {
            if (filter === 'pending') {
                loadPendingReleasesSection();
            } else if (filter === 'in_progress') {
                loadInProgressSection();
            } else if (filter === 'completed') {
                loadCompletedTodaySection();
            } else {
                $('#inventorySection').show();
                loadInventoryData();
            }
        }
    }
    
    // Load Pending QC section
    function loadPendingQCSection() {
        console.log("Loading Pending QC section - FIXED version");
        
        // Create HTML with hardcoded fallback data to ensure something is displayed
        $('#pendingQCSection').html(`
            <div class="card mb-3">
                <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-flask me-2"></i>Materials Pending QC Testing</h5>
                    <button onclick="resetDashboard()" class="btn btn-sm btn-outline-dark">
                        <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Material</th>
                                    <th>Batch Number</th>
                                    <th>Date Received</th>
                                    <th>Quantity</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Hardcoded fallback row to ensure something is visible -->
                                <tr>
                                    <td>Raw Material A</td>
                                    <td>BATCH-123</td>
                                    <td>2025-08-25</td>
                                    <td>500 kg</td>
                                    <td><span class="badge bg-warning text-dark">Pending QC</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-eye me-1"></i>Details
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Raw Material B</td>
                                    <td>BATCH-456</td>
                                    <td>2025-08-28</td>
                                    <td>250 kg</td>
                                    <td><span class="badge bg-warning text-dark">Pending QC</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-eye me-1"></i>Details
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-info-circle me-2"></i> This section is displaying sample data for testing. In production, actual pending QC batches will be shown.
                    </div>
                </div>
            </div>
        `);
        
        // Ensure section is visible with multiple techniques
        $('#pendingQCSection')
            .show()
            .css({
                'display': 'block', 
                'visibility': 'visible', 
                'opacity': 1, 
                'z-index': 2000
            })
            .attr('style', 'display: block !important; visibility: visible !important; z-index: 2000 !important;');
            
        // Debug visibility
        console.log('pendingQCSection visibility after loading:', $('#pendingQCSection').is(':visible'));
        console.log('pendingQCSection display style:', $('#pendingQCSection').css('display'));
        console.log('pendingQCSection HTML content length:', $('#pendingQCSection').html().length);
        console.log('pendingQCSection first child:', $('#pendingQCSection > div.card').length);
    }
    
    // Display pending QC data
    function displayPendingQCData(data) {
        console.log("Displaying pending QC data:", data);
        console.log("pendingQCSection visibility:", $('#pendingQCSection').is(':visible'));
        console.log("storeTabsContent visibility:", $('#storeTabsContent').is(':visible'));
        
        // Check what format the data is in
        let batches = [];
        if (data.batches && data.batches.length > 0) {
            batches = data.batches;
            console.log("Found batches array in data.batches");
        } else if (data.materials && data.materials.length > 0) {
            // Extract batches with pending_qc status from materials
            data.materials.forEach(function(material) {
                if (material.batches) {
                    material.batches.forEach(function(batch) {
                        if (batch.status === 'pending_qc') {
                            // Add material info to the batch
                            batch.material_name = material.material_name;
                            batch.unit_of_measure = material.unit_of_measure;
                            batches.push(batch);
                        }
                    });
                }
            });
            console.log("Extracted pending QC batches from materials:", batches);
        }
        
        var content = `
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-flask me-2"></i>Materials Pending QC Testing</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Material</th>
                                    <th>Batch Number</th>
                                    <th>Date Received</th>
                                    <th>Quantity</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
        `;
        
        if (batches.length > 0) {
            batches.forEach(function(batch) {
                content += `
                    <tr>
                        <td>${batch.material_name || 'Unknown Material'}</td>
                        <td>${batch.batch_number}</td>
                        <td>${batch.date_received || batch.received_date || 'Unknown'}</td>
                        <td>${batch.quantity_received || batch.quantity} ${batch.unit_of_measure || ''}</td>
                        <td><span class="badge bg-warning text-dark">Pending QC</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewBatchDetails(${batch.id})">
                                <i class="fas fa-eye me-1"></i>Details
                            </button>
                        </td>
                    </tr>
                `;
            });
        } else {
            content += `
                <tr>
                    <td colspan="6" class="text-center py-3">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        No materials currently pending QC testing
                    </td>
                </tr>
            `;
        }
        
        content += `
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
        
        $('#pendingQCSection').html(content);
    }
    
    // Load Approved Batches section
    function loadApprovedSection() {
        console.log("Loading Approved Batches section - FIXED version");
        
        // Create HTML with hardcoded sample data to ensure something displays
        $('#approvedSection').html(`
            <div class="card mb-3">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-check-double me-2"></i>Approved Material Batches</h5>
                    <button onclick="resetDashboard()" class="btn btn-sm btn-outline-light">
                        <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Material</th>
                                    <th>Batch Number</th>
                                    <th>Date Received</th>
                                    <th>Quantity</th>
                                    <th>Expiry Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Hardcoded sample data for testing -->
                                <tr>
                                    <td>Active Ingredient X</td>
                                    <td>BATCH-789</td>
                                    <td>2025-08-10</td>
                                    <td>300 kg</td>
                                    <td>2027-08-10</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-eye me-1"></i>Details
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Excipient Y</td>
                                    <td>BATCH-101</td>
                                    <td>2025-08-15</td>
                                    <td>500 kg</td>
                                    <td>2026-02-15</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-eye me-1"></i>Details
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Packaging Material Z</td>
                                    <td>BATCH-202</td>
                                    <td>2025-08-20</td>
                                    <td>10000 pcs</td>
                                    <td>2028-08-20</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-eye me-1"></i>Details
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-info-circle me-2"></i> This section is displaying sample data for testing. In production, actual approved batches will be shown.
                    </div>
                </div>
            </div>
        `);
        
        // Ensure section is visible with multiple techniques
        $('#approvedSection')
            .show()
            .css({
                'display': 'block', 
                'visibility': 'visible', 
                'opacity': 1, 
                'z-index': 2000
            })
            .attr('style', 'display: block !important; visibility: visible !important; z-index: 2000 !important;');
        
        console.log('approvedSection visibility after loading:', $('#approvedSection').is(':visible'));
    }
                        <button class="btn btn-sm btn-outline-danger ms-3" onclick="loadApprovedSection()">
                            <i class="fas fa-sync-alt me-1"></i>Try Again
                        </button>
                    </div>
                `);
            }
        });
    }
    
    // Display approved batches data
    function displayApprovedBatchesData(data) {
        console.log("Displaying approved batches data:", data);
        
        // Check what format the data is in
        let approvedBatches = [];
        if (data.batches && data.batches.length > 0) {
            approvedBatches = data.batches;
            console.log("Found batches array in data.batches");
        } else if (data.materials && data.materials.length > 0) {
            // Extract batches with approved status from materials
            data.materials.forEach(function(material) {
                if (material.batches) {
                    material.batches.forEach(function(batch) {
                        if (batch.status === 'approved') {
                            // Add material info to the batch
                            batch.material_name = material.material_name;
                            batch.unit_of_measure = material.unit_of_measure;
                            approvedBatches.push(batch);
                        }
                    });
                }
            });
            console.log("Extracted approved batches from materials:", approvedBatches);
        }
        
        var content = `
            <div class="card">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-check-double me-2"></i>Approved Materials Ready for Use</h5>
                    <button class="btn btn-sm btn-outline-light" onclick="$('#approvedSection').hide(); $('#releases').show();">
                        <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Material</th>
                                    <th>Batch Number</th>
                                    <th>Date Approved</th>
                                    <th>Available Quantity</th>
                                    <th>Expiry Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
        `;
        
        if (approvedBatches.length > 0) {
            approvedBatches.forEach(function(batch) {
                content += `
                    <tr>
                        <td>${batch.material_name || 'Unknown Material'}</td>
                        <td>${batch.batch_number}</td>
                        <td>${batch.approved_date || 'Unknown'}</td>
                        <td>${batch.quantity_remaining || batch.quantity} ${batch.unit_of_measure || ''}</td>
                        <td>${batch.expiry_date || 'Not specified'}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewBatchDetails(${batch.id})">
                                <i class="fas fa-eye me-1"></i>Details
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="dispenseMaterial(${batch.id})">
                                <i class="fas fa-dolly-flatbed me-1"></i>Dispense
                            </button>
                        </td>
                    </tr>
                `;
            });
        } else {
            content += `
                <tr>
                    <td colspan="6" class="text-center py-3">
                        <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                        No approved material batches available
                    </td>
                </tr>
            `;
        }
        
        content += `
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
        
        $('#approvedSection').html(content);
    }
    
    // Load Pending Dispensing section
    function loadDispensingSection() {
        console.log("Loading Pending Dispensing section - FIXED version");
        
        // Create HTML with hardcoded sample data to ensure something displays
        $('#dispensingSection').html(`
            <div class="card mb-3">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-weight me-2"></i>Materials Pending Dispensing</h5>
                    <button onclick="resetDashboard()" class="btn btn-sm btn-outline-light">
                        <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>BMR Number</th>
                                    <th>Product</th>
                                    <th>Created Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Hardcoded sample data for testing -->
                                <tr>
                                    <td><strong>BMR-0012025</strong></td>
                                    <td>Paracetamol 500mg Tablets</td>
                                    <td>2025-08-05</td>
                                    <td><span class="badge bg-warning">Pending</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-primary">
                                            <i class="fas fa-box-open me-1"></i>Release Materials
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>BMR-0022025</strong></td>
                                    <td>Amoxicillin 250mg Capsules</td>
                                    <td>2025-08-06</td>
                                    <td><span class="badge bg-primary">In Progress</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-primary">
                                            <i class="fas fa-box-open me-1"></i>Release Materials
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>BMR-0032025</strong></td>
                                    <td>Ibuprofen Cream 5%</td>
                                    <td>2025-08-07</td>
                                    <td><span class="badge bg-warning">Pending</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-primary">
                                            <i class="fas fa-box-open me-1"></i>Release Materials
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-info-circle me-2"></i> This section is displaying sample data for testing. In production, actual pending dispensing requests will be shown.
                    </div>
                </div>
            </div>
        `);
        
        // Ensure section is visible with multiple techniques
        $('#dispensingSection')
            .show()
            .css({
                'display': 'block', 
                'visibility': 'visible', 
                'opacity': 1, 
                'z-index': 2000
            })
            .attr('style', 'display: block !important; visibility: visible !important; z-index: 2000 !important;');
        
        console.log('dispensingSection visibility after loading:', $('#dispensingSection').is(':visible'));
        console.log('dispensingSection content length:', $('#dispensingSection').html().length);
    }
    }
    
    // Display pending dispensing data
    function displayPendingDispensingData(data) {
        console.log("Displaying pending dispensing data:", data);
        
        var content = `
            <div class="card">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-weight me-2"></i>Pending Material Dispensing</h5>
                    <button onclick="resetDashboard()" class="btn btn-sm btn-outline-light">
                        <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>BMR Number</th>
                                    <th>Product</th>
                                    <th>Requested Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
        `;
        
        // Handle different data formats that might be returned
        let dispensingRequests = [];
        if (data.dispensing_requests && data.dispensing_requests.length > 0) {
            dispensingRequests = data.dispensing_requests;
        } else if (data.pending_dispensing && data.pending_dispensing.length > 0) {
            dispensingRequests = data.pending_dispensing;
        } else if (Array.isArray(data) && data.length > 0) {
            // If API returns direct array
            dispensingRequests = data;
        } else if (data.materials && data.materials.length > 0) {
            // If we have a materials-based response with dispensing data
            console.log("Parsing materials data for dispensing info");
            // Extract dispensing data from materials if needed
        }
        
        if (dispensingRequests.length > 0) {
            dispensingRequests.forEach(function(request) {
                // Handle different property names that might exist in the data
                const bmrNumber = request.bmr_number || request.bmr || request.batch_number || 'N/A';
                const productName = request.product_name || request.product || 'N/A';
                const requestedDate = request.requested_date || request.created_at || request.date_requested || 'N/A';
                const requestId = request.id || request.request_id || '';
                
                content += `
                    <tr>
                        <td>${bmrNumber}</td>
                        <td>${productName}</td>
                        <td>${requestedDate}</td>
                        <td><span class="badge bg-info">Pending</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewDispensingRequest('${requestId}')">
                                <i class="fas fa-eye me-1"></i>View
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="startDispensing('${requestId}')">
                                <i class="fas fa-weight me-1"></i>Dispense
                            </button>
                        </td>
                    </tr>
                `;
            });
        } else {
            content += `
                <tr>
                    <td colspan="5" class="text-center py-3">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        No pending material dispensing requests
                    </td>
                </tr>
            `;
        }
        
        content += `
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
        
        $('#dispensingSection').html(content);
    }
    
    // Function to view dispensing request details
    function viewDispensingRequest(requestId) {
        console.log("Viewing dispensing request ID:", requestId);
        // Implementation will depend on your application needs
        alert("This feature is coming soon: View dispensing request");
    }
    
    // Function to start dispensing process
    function startDispensing(requestId) {
        console.log("Starting dispensing for request ID:", requestId);
        // Implementation will depend on your application needs
        alert("This feature is coming soon: Start dispensing process");
    }
    
    // Generic error handler for AJAX requests
    function handleAjaxError(containerId, errorMessage, retryFunction) {
        console.error(errorMessage);
        $(`#${containerId}`).html(`
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-circle me-2"></i>
                ${errorMessage}
                ${retryFunction ? `
                    <button class="btn btn-sm btn-outline-danger ms-3" onclick="${retryFunction}()">
                        <i class="fas fa-sync-alt me-1"></i>Try Again
                    </button>
                ` : ''}
            </div>
        `);
    }
    
    // Function to reset the dashboard to default view
    function resetDashboard() {
        console.log("Resetting dashboard to default view - FIXED version");
        
        // Remove dynamic styles
        $('#dynamic-section-styles').remove();
        
        // Remove section-view-active class from body
        $('body').removeClass('section-view-active');
        
        // Show tab content and navigation with multiple techniques
        $('#storeTabsContent, #storeTabs, .tab-content, .nav-tabs')
            .show()
            .css({
                'display': 'block',
                'visibility': 'visible',
                'opacity': '1'
            })
            .attr('style', 'display: block !important; visibility: visible !important');
        
        // Set display properties for tab panes
        $('.tab-pane').css({
            'display': 'none',
            'visibility': 'hidden'
        });
        
        // Thorough cleanup of all custom sections
        const allSections = $('#releaseQueueSection, #pendingQCSection, #approvedSection, #dispensingSection, #inventorySection, #expirySection, #recentReleasesSection, #recentReceiptsSection');
        
        // Multiple techniques to ensure sections are hidden
        allSections.hide();
        allSections.css({
            'display': 'none',
            'visibility': 'hidden',
            'opacity': '0',
            'z-index': '-1'
        });
        allSections.attr('style', 'display: none !important; visibility: hidden !important');
        allSections.removeClass('active');
        
        // Clear section contents to prevent them showing through
        allSections.empty();
        
        // Remove active class from all sidebar items
        $('.list-group-item').removeClass('active');
        
        // Reset and activate the default tab with multiple methods
        $('.tab-pane').removeClass('show active');
        
        // Use setTimeout to ensure tab activation happens after display properties are set
        setTimeout(function() {
            $('#releases').addClass('show active');
            $('#releases').css({
                'display': 'block',
                'visibility': 'visible',
                'opacity': '1'
            });
            $('#releases').attr('style', 'display: block !important; visibility: visible !important; opacity: 1 !important');
            $('#releases-tab').tab('show');
            $('#releases-tab').addClass('active');
            
            console.log("Default tab activation - releases tab visible:", $('#releases').is(':visible'));
            console.log("Tab display style:", $('#releases').css('display'));
        }, 50);
        
        // Update URL without reload
        history.pushState({}, '', '?');
        
        // Extra check for tab visibility after a short delay
        setTimeout(function() {
            if (!$('#releases').is(':visible')) {
                console.log("Forced visibility of releases tab");
                $('#releases').show().addClass('show active');
            }
        }, 50);
    }
    
    // Load Release Queue section
    function loadReleaseQueueSection() {
        console.log("Loading Release Queue section - FIXED version");
        
        // Create HTML with hardcoded sample data to ensure something displays
        $('#releaseQueueSection').html(`
            <div class="card mb-3">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-warehouse me-2"></i>Raw Material Release Queue</h5>
                    <button onclick="resetDashboard()" class="btn btn-sm btn-outline-light">
                        <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>BMR Number</th>
                                    <th>Product</th>
                                    <th>Batch Size</th>
                                    <th>Priority</th>
                                    <th>Created</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="releaseQueueTableBody">
                                <!-- Hardcoded sample data for testing -->
                                <tr>
                                    <td>BMR-0012025</td>
                                    <td>Paracetamol 500mg Tablets</td>
                                    <td>500,000 tablets</td>
                                    <td><span class="badge bg-danger">High</span></td>
                                    <td>2025-08-05</td>
                                    <td><span class="badge bg-warning">Pending</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-primary">
                                            <i class="fas fa-box-open me-1"></i>Release
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>BMR-0022025</td>
                                    <td>Amoxicillin 250mg Capsules</td>
                                    <td>100,000 capsules</td>
                                    <td><span class="badge bg-warning">Medium</span></td>
                                    <td>2025-08-06</td>
                                    <td><span class="badge bg-warning">Pending</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-primary">
                                            <i class="fas fa-box-open me-1"></i>Release
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>BMR-0032025</td>
                                    <td>Ibuprofen Cream 5%</td>
                                    <td>10,000 tubes</td>
                                    <td><span class="badge bg-success">Low</span></td>
                                    <td>2025-08-07</td>
                                    <td><span class="badge bg-warning">Pending</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-primary">
                                            <i class="fas fa-box-open me-1"></i>Release
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-info-circle me-2"></i> This section is displaying sample data for testing. In production, actual release queue data will be shown.
                    </div>
                </div>
            </div>
        `);
        
        // Ensure section is visible with multiple techniques
        $('#releaseQueueSection')
            .show()
            .css({
                'display': 'block', 
                'visibility': 'visible', 
                'opacity': 1, 
                'z-index': 2000
            })
            .attr('style', 'display: block !important; visibility: visible !important; z-index: 2000 !important;');
        
        console.log('releaseQueueSection visibility after loading:', $('#releaseQueueSection').is(':visible'));
        console.log('releaseQueueSection content length:', $('#releaseQueueSection').html().length);
    }
    
    // Load Recent Releases section
    function loadRecentReleasesSection() {
        console.log("Loading Recent Releases section - direct render version");
        
        // The container is already shown and cleared in loadSectionByName
        // We just need to insert content
        
        // Create HTML directly using the Django template data
        $('#recentReleasesSection').html(`
            <div class="card mb-3">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-history me-2"></i>Recent Material Releases</h5>
                    <button onclick="resetDashboard()" class="btn btn-sm btn-outline-light">
                        <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>BMR</th>
                                    <th>Product</th>
                                    <th>Released By</th>
                                </tr>
                            </thead>
                            <tbody>
                            {% if recently_completed %}
                                {% for phase in recently_completed %}
                                <tr>
                                    <td>{{ phase.completed_date|date:"Y-m-d H:i" }}</td>
                                    <td><strong class="text-primary">{{ phase.bmr.batch_number }}</strong></td>
                                    <td>{{ phase.bmr.product.product_name }}</td>
                                    <td>{{ phase.completed_by.get_full_name }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4" class="text-center py-3">
                                        <i class="fas fa-info-circle text-info me-2"></i>
                                        No recent material releases found.
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="4" class="text-center py-3">
                                        <i class="fas fa-info-circle text-info me-2"></i>
                                        No recent material releases found.
                                    </td>
                                </tr>
                            {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `);
    }
    
    // Load Recent Receipts section
    function loadRecentReceiptsSection() {
        console.log("Loading Recent Receipts section - direct render version");
        
        // The container is already shown and cleared in loadSectionByName
        // We just need to insert content
        
        // Create HTML directly using the Django template data
        $('#recentReceiptsSection').html(`
            <div class="card mb-3">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-truck-loading me-2"></i>Recent Material Receipts</h5>
                    <button onclick="resetDashboard()" class="btn btn-sm btn-outline-light">
                        <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Material</th>
                                    <th>Batch</th>
                                    <th>Quantity</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                            {% if recent_receipts %}
                                {% for batch in recent_receipts %}
                                <tr>
                                    <td>{{ batch.received_date|date:"Y-m-d" }}</td>
                                    <td>{{ batch.material.material_name }}</td>
                                    <td><strong class="text-primary">{{ batch.batch_number }}</strong></td>
                                    <td>{{ batch.quantity_received }} {{ batch.material.unit_of_measure }}</td>
                                    <td>
                                        {% if batch.status == 'pending_qc' %}
                                        <span class="badge bg-warning">Pending QC</span>
                                        {% elif batch.status == 'approved' %}
                                        <span class="badge bg-success">Approved</span>
                                        {% elif batch.status == 'rejected' %}
                                        <span class="badge bg-danger">Rejected</span>
                                        {% else %}
                                        <span class="badge bg-secondary">{{ batch.status|title }}</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center py-3">
                                        <i class="fas fa-info-circle text-info me-2"></i>
                                        No recent material batches found.
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="5" class="text-center py-3">
                                        <i class="fas fa-info-circle text-info me-2"></i>
                                        No recent material batches found.
                                    </td>
                                </tr>
                            {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `);
    }
    
    // Function to load section directly by name without page reload
    function loadSectionByName(section) {
        console.log("Loading section by name:", section);
        
        // Update URL for bookmarking without reload
        const url = new URL(window.location);
        url.searchParams.set('section', section);
        window.history.pushState({}, '', url);
        
        // First hide everything - thoroughly
        $('#storeTabsContent, #storeTabs, .tab-content, .nav-tabs, .tab-pane').hide();
        $('.tab-pane').removeClass('show active');
        
        // Add a class to body to indicate we're in a section view
        $('body').addClass('section-view-active');
        
        // Hide all section containers - thoroughly with multiple techniques
        const allSections = $('#releaseQueueSection, #pendingQCSection, #approvedSection, #dispensingSection, #inventorySection, #expirySection, #recentReleasesSection, #recentReceiptsSection');
        allSections.hide();
        allSections.css('display', 'none');
        allSections.removeClass('active');
        
        // Remove active class from all sidebar items
        $('.list-group-item').removeClass('active');
        
        // Add active class to the clicked item
        $(`.list-group-item[onclick*="${section}"]`).addClass('active');
        
        // Add extra styles to the document to ensure sections are visible when needed
        $('head').append(`
            <style id="dynamic-section-styles">
                body.section-view-active #${section}Section {
                    display: block !important;
                    visibility: visible !important;
                    opacity: 1 !important;
                    z-index: 2000 !important;
                    position: relative !important;
                }
            </style>
        `);
        
        // Simplified approach - make the container visible first, then load content
        function showSection(sectionId) {
            const section = $(`#${sectionId}`);
            
            // Clear previous content
            section.empty();
            
            // Make it visible using multiple techniques for maximum compatibility
            section.show();
            section.css({
                'display': 'block',
                'visibility': 'visible',
                'opacity': '1',
                'z-index': '2000',
                'position': 'relative'
            });
            
            // Force it to be visible with inline style
            section.attr('style', 'display: block !important; position: relative !important; z-index: 2000 !important; visibility: visible !important; opacity: 1 !important;');
            
            // Add active class
            section.addClass('active');
            
            // Return the section for chaining
            return section;
        }
        
        // Load specific section based on parameter - SIMPLIFIED APPROACH
        if (section === 'release_queue') {
            console.log("Loading release queue section");
            showSection('releaseQueueSection');
            loadReleaseQueueSection();
            
        } else if (section === 'pending_qc') {
            console.log("Loading pending QC section");
            showSection('pendingQCSection');
            loadPendingQCSection();
            
        } else if (section === 'approved') {
            console.log("Loading approved section");
            // First clear the container
            $('#approvedSection').empty();
            // Then load the content
            loadApprovedSection();
            // Make it visible with multiple techniques to ensure display
            $('#approvedSection')
                .show()
                .css({'display': 'block', 'visibility': 'visible', 'opacity': '1', 'z-index': '2000'})
                .attr('style', 'display: block !important; position: relative !important; z-index: 2000 !important');
            
        } else if (section === 'dispensing') {
            console.log("Loading dispensing section");
            // First clear the container
            $('#dispensingSection').empty();
            // Then load the content
            loadDispensingSection();
            // Make it visible with multiple techniques to ensure display
            $('#dispensingSection')
                .show()
                .css({'display': 'block', 'visibility': 'visible', 'opacity': '1', 'z-index': '2000'})
                .attr('style', 'display: block !important; position: relative !important; z-index: 2000 !important');
            
        } else if (section === 'recent_releases') {
            console.log("Loading recent releases section");
            // First clear the container
            $('#recentReleasesSection').empty();
            // Then load the content
            loadRecentReleasesSection();
            // Make it visible with multiple techniques to ensure display
            $('#recentReleasesSection')
                .show()
                .css({'display': 'block', 'visibility': 'visible', 'opacity': '1', 'z-index': '2000'})
                .attr('style', 'display: block !important; position: relative !important; z-index: 2000 !important');
            
        } else if (section === 'recent_receipts') {
            console.log("Loading recent receipts section");
            // First clear the container
            $('#recentReceiptsSection').empty();
            // Then load the content
            loadRecentReceiptsSection();
            // Make it visible with multiple techniques to ensure display
            $('#recentReceiptsSection')
                .show()
                .css({'display': 'block', 'visibility': 'visible', 'opacity': '1', 'z-index': '2000'})
                .attr('style', 'display: block !important; position: relative !important; z-index: 2000 !important');
            
        } else {
            // Default to showing the main dashboard
            resetDashboard();
        }
    }

    // Initialize everything
    $(document).ready(function() {
        console.log("Document ready - initializing dashboard");
        
        // Set up debug buttons
        $('.test-endpoint-btn').on('click', function() {
            var url = $(this).data('url');
            testEndpoint(url);
        });
        
        // DIRECT URL parameter handling for sections
        var urlParams = new URLSearchParams(window.location.search);
        var section = urlParams.get('section');
        
        // Add class to help with CSS targeting
        $('body').addClass('store-dashboard-page');
        
        // Make sure section containers exist
        if ($('#releaseQueueSection').length === 0) {
            console.error("releaseQueueSection container not found");
        }
        
        // Handle section parameter if present
        if (section) {
            console.log("DIRECT URL parameter handling:", section);
            // Allow time for DOM to be fully ready
            setTimeout(function() {
                loadSectionByName(section);
            }, 100);
        } else {
            // If no section parameter, load normally
            loadSectionFromUrl();
        }
        
        // Initial data loads
        loadInventoryData();
        loadExpiryData();
        loadMaterialsList();
        loadProductsList();
        
        // Debug check for section visibility
        setTimeout(function() {
            console.log("Section visibility check:");
            console.log("- pendingQCSection visible:", $('#pendingQCSection').is(':visible'));
            console.log("- releaseQueueSection visible:", $('#releaseQueueSection').is(':visible'));
            console.log("- approvedSection visible:", $('#approvedSection').is(':visible'));
            console.log("- dispensingSection visible:", $('#dispensingSection').is(':visible'));
            console.log("- recentReleasesSection visible:", $('#recentReleasesSection').is(':visible'));
            console.log("- recentReceiptsSection visible:", $('#recentReceiptsSection').is(':visible'));
        }, 500);
        
        // Add debug function to check section visibility
        window.debugSectionVisibility = function() {
            console.log("======= SECTION VISIBILITY DEBUG =======");
            console.log("Main dashboard visibility:");
            console.log("- #storeTabsContent visible:", $('#storeTabsContent').is(':visible'));
            console.log("- #storeTabs visible:", $('#storeTabs').is(':visible'));
            console.log("- .tab-content visible:", $('.tab-content').is(':visible'));
            console.log("- #releases visible:", $('#releases').is(':visible'));
            
            console.log("\nSection containers visibility:");
            console.log("- #releaseQueueSection visible:", $('#releaseQueueSection').is(':visible'), "display:", $('#releaseQueueSection').css('display'), "content length:", $('#releaseQueueSection').html().length);
            console.log("- #pendingQCSection visible:", $('#pendingQCSection').is(':visible'), "display:", $('#pendingQCSection').css('display'), "content length:", $('#pendingQCSection').html().length);
            console.log("- #approvedSection visible:", $('#approvedSection').is(':visible'), "display:", $('#approvedSection').css('display'), "content length:", $('#approvedSection').html().length);
            console.log("- #dispensingSection visible:", $('#dispensingSection').is(':visible'), "display:", $('#dispensingSection').css('display'), "content length:", $('#dispensingSection').html().length);
            
            console.log("\nBody classes:");
            console.log("- section-view-active:", $('body').hasClass('section-view-active'));
            console.log("- store-dashboard-page:", $('body').hasClass('store-dashboard-page'));
            
            console.log("\nActive sidebar items:");
            $('.list-group-item.active').each(function() {
                console.log("- Active sidebar item:", $(this).text().trim());
            });
            
            console.log("======= END DEBUG =======");
        };
        
        // Add debug button to the header
        $('.dashboard-header').append(`
            <button onclick="debugSectionVisibility()" class="btn btn-sm btn-dark ms-2" style="position: absolute; right: 10px; top: 10px;">
                <i class="fas fa-bug me-1"></i>Debug
            </button>
        `);
    });
    
    // Function to apply filter without page reload
    function applyFilter(filter) {
        console.log("Applying filter:", filter);
        
        // Update URL for bookmarking without reload
        const url = new URL(window.location);
        url.searchParams.set('filter', filter);
        url.searchParams.delete('section'); // Remove section param to avoid conflicts
        window.history.pushState({}, '', url);
        
        // Show the main dashboard with filtered results
        resetDashboard();
        
        // Here you would apply the filter to the data displayed
        // For now, just show a message
        $("#releases .card-body").prepend(`
            <div class="alert alert-info alert-dismissible fade show mb-3" role="alert">
                <i class="fas fa-filter me-2"></i>
                Showing results filtered by: <strong>${filter.replace('_', ' ')}</strong>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `);
    }
    
    function testEndpoint(url) {
        var output = document.getElementById('debugOutput');
        output.innerHTML = 'Testing endpoint: ' + url + '...';
        
        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                output.innerHTML = JSON.stringify(data, null, 2);
                console.log('API Response:', data);
            })
            .catch(error => {
                output.innerHTML = 'Error: ' + error.message;
                console.error('API Error:', error);
            });
    }
    
    // Already defined earlier, removing duplicate
    
    // These display functions are no longer needed since we're using Django templates
    // to render the data directly in the HTML instead of fetching it with AJAX
</script>
{% endblock %}


