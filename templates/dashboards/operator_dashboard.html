{% extends 'base.html' %}

{% block title %}{{ dashboard_title }} - Kampala Pharmaceutical Industries{% endblock %}

{% block content %}
<!-- Simple anti-blink CSS -->
<style>
    /* Disable hover effects on table rows */
    .materials-table-container .table tr:hover,
    .materials-table-container .table-hover tbody tr:hover {
        background-color: transparent !important;
    }
    
    /* Disable transitions for modal content */
    .modal-content *,
    .materials-table-container * {
        transition: none !important;
        animation: none !important;
    }
    
    /* Fixed table layout */
    .materials-table-container {
        height: 300px;
        overflow-y: auto;
        position: relative;
    }
    
    .materials-table-container table {
        table-layout: fixed !important;
        width: 100% !important;
    }
    
    /* Fixed header */
    .materials-table-container th {
        position: sticky;
        top: 0;
        z-index: 1;
        background-color: #f8f9fa;
    }
</style>

<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="text-primary mb-0">
                        <i class="fas fa-cogs me-2"></i>{{ dashboard_title }}
                    </h2>
                    <p class="text-muted mb-0">Production Phase Management</p>
                </div>
                <div class="text-end">
                    <small class="text-muted">Welcome, {{ user.get_full_name|default:user.username }}</small><br>
                    <small class="text-success">{{ user.get_role_display }}</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Navigation -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-body py-2">
                    <div class="d-flex justify-content-center">
                        <nav class="btn-group" role="group">
                            <a href="{% url 'dashboards:dashboard_home' %}" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-home me-1"></i>Dashboard
                            </a>
                            <a href="{% url 'reports:timeline_list' %}" class="btn btn-outline-info btn-sm">
                                <i class="fas fa-project-diagram me-1"></i>Visual Timeline
                            </a>
                            <a href="{% url 'reports:comments_report' %}" class="btn btn-outline-success btn-sm">
                                <i class="fas fa-comments me-1"></i>Comments
                            </a>
                            <a href="{% url 'bmr:list' %}" class="btn btn-outline-warning btn-sm">
                                <i class="fas fa-file-medical me-1"></i>BMRs
                            </a>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <a href="?filter=total_batches" class="text-decoration-none">
                <div class="card text-white bg-primary mb-3">
                    <div class="card-body">
                        <h6 class="card-title"><i class="fas fa-clipboard-list"></i> Total Batches</h6>
                        <h3 class="card-text">{{ stats.total_batches }}</h3>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-3">
            <a href="?filter=completed_today" class="text-decoration-none">
                <div class="card text-white bg-success mb-3">
                    <div class="card-body">
                        <h6 class="card-title"><i class="fas fa-check-circle"></i> Completed Today</h6>
                        <h3 class="card-text">{{ stats.completed_today }}</h3>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-3">
            <a href="?filter=in_progress" class="text-decoration-none">
                <div class="card text-white bg-info mb-3">
                    <div class="card-body">
                        <h6 class="card-title"><i class="fas fa-spinner"></i> In Progress</h6>
                        <h3 class="card-text">{{ stats.in_progress_phases }}</h3>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-3">
            <a href="?filter=pending" class="text-decoration-none">
                <div class="card text-white bg-warning mb-3">
                    <div class="card-body">
                        <h6 class="card-title"><i class="fas fa-exclamation-circle"></i> Pending</h6>
                        <h3 class="card-text">{{ stats.pending_phases }}</h3>
                    </div>
                </div>
            </a>
        </div>
    </div>

    {% if rejected_batches %}
    <!-- Failed Post-Compression QC Tablet Batches for Reprocessing (Only for Granulation Operators) -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-danger">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-recycle me-2"></i>Failed Post-Compression QC Tablet Batches for Reprocessing
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-danger">
                                <tr>
                                    <th>BMR Number</th>
                                    <th>Product</th>
                                    <th>Batch Size</th>
                                    <th>Failed Date</th>
                                    <th>QC Rejection Reason</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in rejected_batches %}
                                <tr>
                                    <td>
                                        <span class="badge bg-danger">{{ item.bmr.bmr_number }}</span>
                                    </td>
                                    <td>{{ item.bmr.product.product_name }}</td>
                                    <td>{{ item.bmr.batch_size|floatformat:0 }} {{ item.bmr.product.unit_of_measure }}</td>
                                    <td>{{ item.failed_date|date:"M d, Y H:i"|default:"N/A" }}</td>
                                    <td>
                                        {% if item.comments %}
                                            {{ item.comments|truncatechars:50 }}
                                        {% else %}
                                            Post-compression QC failed
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.granulation_phase %}
                                            <button type="button" class="btn btn-sm btn-warning" 
                                                    onclick="startPhase('{{ item.granulation_phase.id }}', 'granulation', '{{ item.bmr.bmr_number }}')">
                                                <i class="fas fa-recycle"></i> Start Reprocessing
                                            </button>
                                        {% else %}
                                            <form method="post" action="">
                                                {% csrf_token %}
                                                <input type="hidden" name="bmr_id" value="{{ item.bmr.id }}">
                                                <input type="hidden" name="action" value="setup_reprocess">
                                                <button type="submit" class="btn btn-sm btn-secondary">
                                                    <i class="fas fa-cog"></i> Setup Reprocessing
                                                </button>
                                            </form>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Active Phase Tasks -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-tasks me-2"></i>My {{ phase_name|title }} Tasks
                    </h5>
                </div>
                <div class="card-body">
                    {% if my_phases %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>BMR Number</th>
                                        <th>Product</th>
                                        <th>Product Type</th>
                                        <th>Batch Size</th>
                                        <th>Status</th>
                                        <th>Started</th>
                                        <th>Priority</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for phase in my_phases %}
                                    <tr>
                                        <td>
                                            <strong class="text-primary">{{ phase.bmr.bmr_number }}</strong>
                                        </td>
                                        <td>{{ phase.bmr.product.product_name }}</td>
                                        <td>
                                            <span class="badge bg-secondary">{{ phase.bmr.product.get_product_type_display }}</span>
                                        </td>
                                        <td>{{ phase.bmr.batch_size|floatformat:0 }} {{ phase.bmr.product.unit_of_measure }}</td>
                                        <td>
                                            {% if phase.status == 'pending' %}
                                                <span class="badge bg-warning">Pending</span>
                                            {% elif phase.status == 'in_progress' %}
                                                <span class="badge bg-info">In Progress</span>
                                            {% else %}
                                                <span class="badge bg-success">{{ phase.status|title }}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if phase.started_date %}
                                                {{ phase.started_date|date:"M d, H:i" }}
                                            {% else %}
                                                <span class="text-muted">Not started</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if phase.bmr.created_date|timesince|slice:":1" == "0" %}
                                                <span class="badge bg-danger">Urgent</span>
                                            {% elif phase.bmr.created_date|timesince|slice:":1" == "1" %}
                                                <span class="badge bg-warning">High</span>
                                            {% else %}
                                                <span class="badge bg-success">Normal</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <a href="{% url 'bmr:detail' phase.bmr.pk %}" 
                                                   class="btn btn-outline-primary btn-sm">
                                                    <i class="fas fa-eye"></i> View
                                                </a>
                                                {% if phase.status == 'pending' %}
                                                <button class="btn btn-outline-success btn-sm"
                                                        onclick="startPhase('{{ phase.id }}', '{{ phase.phase.phase_name }}', '{{ phase.bmr.batch_number }}')">
                                                    <i class="fas fa-play"></i> Start
                                                </button>
                                                {% elif phase.status == 'in_progress' %}
                                                <button class="btn btn-outline-warning btn-sm"
                                                        onclick="completePhase('{{ phase.id }}', '{{ phase.phase.phase_name }}', '{{ phase.bmr.batch_number }}')">
                                                    <i class="fas fa-check"></i> Complete
                                                </button>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-clipboard-check fa-3x text-success mb-3"></i>
                            <h5 class="text-muted">No {{ phase_name|title }} Tasks Available</h5>
                            <p class="text-muted">All your {{ phase_name }} tasks are up to date or waiting for previous phases to complete.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Operator Dashboard Section (Dynamic) -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-user-cog"></i> Operator Dashboard</span>
                    <button class="btn btn-outline-light btn-sm" onclick="downloadHistory()"><i class="fas fa-download"></i> Download History</button>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h6><i class="fas fa-history text-primary"></i> My History</h6>
                            <div style="max-height: 180px; overflow-y: auto;">
                                <table class="table table-sm table-bordered mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Date</th>
                                            <th>Batch</th>
                                            <th>Phase</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody id="operator-history">
                                        {% for entry in operator_history %}
                                        <tr>
                                            <td>{{ entry.date }}</td>
                                            <td>
                                                {% if phase_name == 'dispensing' %}
                                                <a href="{% url 'bmr:detail' entry.bmr_id %}" class="text-primary">
                                                    {{ entry.batch }}
                                                </a>
                                                {% else %}
                                                {{ entry.batch }}
                                                {% endif %}
                                            </td>
                                            <td>{{ entry.phase }}</td>
                                            <td>
                                                {% if phase_name == 'dispensing' %}
                                                <a href="{% url 'bmr:materials_detail' entry.bmr_id %}" class="btn btn-sm btn-info" target="_blank">
                                                    <i class="fas fa-clipboard-list"></i> Exact Details
                                                </a>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr><td colspan="4" class="text-center text-muted">No history found.</td></tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            <!-- Materials modals removed to fix blinking issue -->
                        </div>
                        <div class="col-md-4">
                            <h6><i class="fas fa-chart-bar text-success"></i> My Statistics</h6>
                            <ul class="list-group mb-2">
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Batches Handled <span class="badge bg-primary">{{ operator_stats.batches_handled }}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Success Rate <span class="badge bg-success">{{ operator_stats.success_rate }}%</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Avg. Completion Time <span class="badge bg-info text-dark">{{ operator_stats.avg_completion_time }}</span>
                                </li>
                            </ul>
                            <div class="alert alert-info p-2 mb-0"><i class="fas fa-bell"></i> {{ operator_stats.assignment_status }}</div>
                        </div>
                        <div class="col-md-4">
                            <h6><i class="fas fa-tasks text-warning"></i> Current Assignments</h6>
                            <ul class="list-group">
                                {% for assignment in operator_assignments %}
                                <li class="list-group-item">{{ assignment }}</li>
                                {% empty %}
                                <li class="list-group-item text-muted">No current assignments.</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Phase Instructions -->
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-book me-2"></i>{{ phase_name|title }} Instructions
                    </h5>
                </div>
                <div class="card-body">
                    {% if phase_name == 'mixing' %}
                        <h6>Mixing Process Guidelines:</h6>
                        <ul>
                            <li>Verify all raw materials are dispensed correctly</li>
                            <li>Check equipment calibration before starting</li>
                            <li>Follow mixing time and speed parameters</li>
                            <li>Monitor temperature during mixing</li>
                            <li>Take samples for in-process testing</li>
                            <li>Document all observations</li>
                        </ul>
                    {% elif phase_name == 'granulation' %}
                        <h6>Granulation Process Guidelines:</h6>
                        <ul>
                            <li>Ensure blended material is ready</li>
                            <li>Check granulator settings</li>
                            <li>Monitor moisture content</li>
                            <li>Verify granule size distribution</li>
                            <li>Document processing parameters</li>
                        </ul>
                    {% elif phase_name == 'coating' %}
                        <h6>Coating Process Guidelines:</h6>
                        <ul>
                            <li>Verify tablet quality before coating</li>
                            <li>Prepare coating solution as per formula</li>
                            <li>Monitor spray rate and temperature</li>
                            <li>Check coating uniformity</li>
                            <li>Document weight gain</li>
                        </ul>
                    {% else %}
                        <h6>{{ phase_name|title }} Process Guidelines:</h6>
                        <ul>
                            <li>Follow standard operating procedures</li>
                            <li>Verify equipment is clean and calibrated</li>
                            <li>Document all process parameters</li>
                            <li>Take required samples for testing</li>
                            <li>Report any deviations immediately</li>
                        </ul>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line me-2"></i>Today's Progress
                    </h5>
                </div>
                <div class="card-body">
                    <div class="progress mb-3">
                        <div class="progress-bar" role="progressbar" 
                             style="width: {{ daily_progress }}%" 
                             aria-valuenow="{{ daily_progress }}" 
                             aria-valuemin="0" aria-valuemax="100">
                            {{ daily_progress }}%
                        </div>
                    </div>
                    <p class="text-muted">Daily tasks completion</p>
                    
                    <hr>
                    
                    <h6>Quick Stats:</h6>
                    <ul class="list-unstyled">
                        <li><i class="fas fa-play text-info"></i> {{ stats.in_progress_phases }} In Progress</li>
                        <li><i class="fas fa-check text-success"></i> {{ stats.completed_today }} Completed</li>
                        <li><i class="fas fa-clock text-warning"></i> {{ stats.pending_phases }} Pending</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Phase Action Modal -->
<div class="modal fade" id="phaseModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="phaseModalTitle">Phase Action</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="phaseForm" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <div id="phaseModalBody">
                        <!-- Dynamic content -->
                    </div>
                    <div class="form-group mt-3">
                        <label for="phase_comments">Comments:</label>
                        <textarea class="form-control" id="phase_comments" name="comments" rows="3"></textarea>
                    </div>
                    <input type="hidden" id="phase_id_input" name="phase_id">
                    <input type="hidden" id="phase_action" name="action">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="phaseSubmitBtn">Confirm</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function downloadHistory() {
    // Get table rows from operator-history
    var rows = document.querySelectorAll('#operator-history tr');
    var csv = 'Date,Batch,Phase\n';
    rows.forEach(function(row) {
        var cells = row.querySelectorAll('td');
        if (cells.length === 3) {
            var rowData = [];
            for (var i = 0; i < 3; i++) {
                // Escape quotes and commas
                var cellText = (cells[i].innerText || '').replace(/"/g, '""');
                rowData.push('"' + cellText + '"');
            }
            csv += rowData.join(',') + '\n';
        }
    });
    var blob = new Blob([csv], { type: 'text/csv' });
    var url = window.URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'operator_history.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

function startPhase(phaseId, phaseName, bmrNumber) {
    document.getElementById('phaseModalTitle').textContent = `Start ${phaseName.replace('_', ' ').toUpperCase()}`;
    
    // Check if machine selection is required for this phase
    const machineRequiredPhases = ['granulation', 'blending', 'compression', 'coating', 'blister_packing', 'filling'];
    const requiresMachine = machineRequiredPhases.includes(phaseName);
    
    let machineSelect = '';
    if (requiresMachine && {{ available_machines|length }} > 0) {
        machineSelect = `
            <div class="form-group mb-3">
                <label for="machine_select"><strong>Select Machine:</strong> <span class="text-danger">*</span></label>
                <select class="form-control" id="machine_select" name="machine_id" required>
                    <option value="">-- Select a machine --</option>
                    {% for machine in available_machines %}
                    <option value="{{ machine.id }}">{{ machine.name }}</option>
                    {% endfor %}
                </select>
                <small class="text-info">Machine selection is mandatory for this phase.</small>
            </div>
        `;
    }
    
    document.getElementById('phaseModalBody').innerHTML = `
        <p>Are you ready to start the ${phaseName.replace('_', ' ')} phase for BMR ${bmrNumber}?</p>
        <p class="text-info"><small>This will mark the phase as "In Progress" and record your start time.</small></p>
        ${machineSelect}
    `;
    document.getElementById('phase_id_input').value = phaseId;
    document.getElementById('phase_action').value = 'start';
    document.getElementById('phaseSubmitBtn').textContent = 'Start Phase';
    document.getElementById('phaseSubmitBtn').className = 'btn btn-success';
    
    new bootstrap.Modal(document.getElementById('phaseModal')).show();
}

function completePhase(phaseId, phaseName, bmrNumber) {
    // Only show breakdown/changeover tracking for machine-based phases
    const machineBasedPhases = ['granulation', 'blending', 'compression', 'coating', 'blister_packing', 'filling', 'tube_filling', 'mixing'];
    const showBreakdownTracking = machineBasedPhases.includes(phaseName);
    
    let breakdownSection = '';
    if (showBreakdownTracking) {
        breakdownSection = `
        <!-- Breakdown Section -->
        <div class="card mt-3">
            <div class="card-header">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="breakdown_check" name="breakdown_occurred" onchange="toggleBreakdownFields()">
                    <label class="form-check-label" for="breakdown_check">
                        <strong>Breakdown Occurred</strong>
                    </label>
                </div>
            </div>
            <div class="card-body" id="breakdown_fields" style="display: none;">
                <div class="row">
                    <div class="col-md-6">
                        <label for="breakdown_start">From Time:</label>
                        <input type="datetime-local" class="form-control" id="breakdown_start" name="breakdown_start_time">
                    </div>
                    <div class="col-md-6">
                        <label for="breakdown_end">To Time:</label>
                        <input type="datetime-local" class="form-control" id="breakdown_end" name="breakdown_end_time">
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Changeover Section -->
        <div class="card mt-3">
            <div class="card-header">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="changeover_check" name="changeover_occurred" onchange="toggleChangeoverFields()">
                    <label class="form-check-label" for="changeover_check">
                        <strong>Changeover Occurred</strong>
                    </label>
                </div>
            </div>
            <div class="card-body" id="changeover_fields" style="display: none;">
                <div class="row">
                    <div class="col-md-6">
                        <label for="changeover_start">From Time:</label>
                        <input type="datetime-local" class="form-control" id="changeover_start" name="changeover_start_time">
                    </div>
                    <div class="col-md-6">
                        <label for="changeover_end">To Time:</label>
                        <input type="datetime-local" class="form-control" id="changeover_end" name="changeover_end_time">
                    </div>
                </div>
            </div>
        </div>`;
    }
    
    document.getElementById('phaseModalTitle').textContent = `Complete ${phaseName.replace('_', ' ').toUpperCase()}`;
    document.getElementById('phaseModalBody').innerHTML = `
        <p>Mark the ${phaseName.replace('_', ' ')} phase as completed for BMR ${bmrNumber}?</p>
        <p class="text-warning"><small>Please ensure all process parameters are documented and samples are taken before completing.</small></p>
        ${breakdownSection}
    `;
    document.getElementById('phase_id_input').value = phaseId;
    document.getElementById('phase_action').value = 'complete';
    document.getElementById('phaseSubmitBtn').textContent = 'Complete Phase';
    document.getElementById('phaseSubmitBtn').className = 'btn btn-warning';
    
    new bootstrap.Modal(document.getElementById('phaseModal')).show();
}

// Toggle functions for breakdown and changeover fields
function toggleBreakdownFields() {
    const checkbox = document.getElementById('breakdown_check');
    const fields = document.getElementById('breakdown_fields');
    fields.style.display = checkbox.checked ? 'block' : 'none';
}

function toggleChangeoverFields() {
    const checkbox = document.getElementById('changeover_check');
    const fields = document.getElementById('changeover_fields');
    fields.style.display = checkbox.checked ? 'block' : 'none';
}

// Handle form submission
document.getElementById('phaseForm').addEventListener('submit', function(e) {
    // Allow normal form submission to POST to the same URL
    return true;
});

// Helper function to get the appropriate status badge for dispensing dashboard
function getStatusBadge(material) {
    return material.is_dispensed ? 
        '<span class="badge bg-success">Dispensed</span>' : 
        '<span class="badge bg-warning">Pending</span>';
}

// Helper function to get the materials text
function getPhaseMaterialsText() {
    return 'materials';
}

// Material modals code removed to fix blinking issue

</script>
{% endblock %}
