{% extends 'base.html' %}

{% block title %}Store Dashboard with Sidebar - Kampala Pharmaceutical Industries{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="text-primary mb-0">
                        <i class="fas fa-warehouse me-2"></i>Store Manager Dashboard
                    </h2>
                    <p class="text-muted mb-0">Raw Material Release Management</p>
                </div>
                <div class="text-end">
                    <small class="text-muted">Welcome, {{ user.get_full_name|default:user.username }}</small><br>
                    <small class="text-success">{{ user.get_role_display }}</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title mb-0">{{ stats.pending_phases }}</h5>
                            <p class="card-text">Pending Releases</p>
                        </div>
                        <i class="fas fa-clock fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title mb-0">{{ stats.in_progress_phases }}</h5>
                            <p class="card-text">In Progress</p>
                        </div>
                        <i class="fas fa-box fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title mb-0">{{ stats.completed_today }}</h5>
                            <p class="card-text">Completed Today</p>
                        </div>
                        <i class="fas fa-check-circle fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title mb-0">{{ stats.total_batches }}</h5>
                            <p class="card-text">Total Batches</p>
                        </div>
                        <i class="fas fa-clipboard-check fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <!-- Sidebar Navigation -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Store Dashboard</h5>
                </div>
                <div class="list-group list-group-flush" id="sidebar-tabs" role="tablist">
                    <a class="list-group-item list-group-item-action active" id="raw-material-release-tab" data-toggle="tab" href="#raw-material-release" role="tab" aria-controls="raw-material-release" aria-selected="true">
                        <i class="fas fa-box-open mr-2"></i> Raw Material Release
                    </a>
                    <a class="list-group-item list-group-item-action" id="inventory-tab" data-toggle="tab" href="#inventory" role="tab" aria-controls="inventory" aria-selected="false">
                        <i class="fas fa-warehouse mr-2"></i> Inventory Management
                    </a>
                    <a class="list-group-item list-group-item-action" id="materials-tab" data-toggle="tab" href="#materials" role="tab" aria-controls="materials" aria-selected="false">
                        <i class="fas fa-flask mr-2"></i> Raw Materials
                    </a>
                    <a class="list-group-item list-group-item-action" id="add-material-tab" data-toggle="tab" href="#add-material" role="tab" aria-controls="add-material" aria-selected="false">
                        <i class="fas fa-plus-circle mr-2"></i> Add New Material
                    </a>
                    <a class="list-group-item list-group-item-action" id="receive-batch-tab" data-toggle="tab" href="#receive-batch" role="tab" aria-controls="receive-batch" aria-selected="false">
                        <i class="fas fa-truck-loading mr-2"></i> Receive Raw Material Batch
                    </a>
                    <a class="list-group-item list-group-item-action" id="expiry-tab" data-toggle="tab" href="#expiry" role="tab" aria-controls="expiry" aria-selected="false">
                        <i class="fas fa-calendar-times mr-2"></i> Expiry Tracking
                    </a>
                    <a class="list-group-item list-group-item-action" id="history-tab" data-toggle="tab" href="#history" role="tab" aria-controls="history" aria-selected="false">
                        <i class="fas fa-history mr-2"></i> Recent Activity
                    </a>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-lg-9 col-md-8">
            <div class="tab-content" id="storeTabsContent">
                <!-- Material Releases Tab -->
                <div class="tab-pane fade show active" id="raw-material-release" role="tabpanel" aria-labelledby="raw-material-release-tab">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-box-open me-2"></i>Raw Material Release Queue
                            </h5>
                        </div>
                        <div class="card-body">
                            {% if my_phases %}
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>BMR Number</th>
                                                <th>Product</th>
                                                <th>Batch Size</th>
                                                <th>Priority</th>
                                                <th>Created</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for phase in my_phases %}
                                            <tr>
                                                <td><strong class="text-primary">{{ phase.bmr.bmr_number }}</strong></td>
                                                <td>{{ phase.bmr.product.product_name }}</td>
                                                <td>{{ phase.bmr.batch_size|floatformat:0 }} {{ phase.bmr.product.unit_of_measure }}</td>
                                                <td>
                                                    {% if phase.bmr.created_date|timesince|slice:":1" == "0" %}
                                                        <span class="badge bg-danger">Urgent</span>
                                                    {% elif phase.bmr.created_date|timesince|slice:":1" == "1" %}
                                                        <span class="badge bg-warning">High</span>
                                                    {% else %}
                                                        <span class="badge bg-success">Normal</span>
                                                    {% endif %}
                                                </td>
                                                <td>{{ phase.bmr.created_date|date:"M d, H:i" }}</td>
                                                <td>
                                                    {% if phase.status == 'pending' %}
                                                        <span class="badge bg-warning">Pending</span>
                                                    {% elif phase.status == 'in_progress' %}
                                                        <span class="badge bg-info">In Progress</span>
                                                    {% else %}
                                                        <span class="badge bg-success">{{ phase.status|title }}</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <div class="btn-group btn-group-sm">
                                                        <a href="{% url 'bmr:detail' phase.bmr.pk %}" 
                                                           class="btn btn-outline-primary btn-sm">
                                                            <i class="fas fa-eye"></i> View
                                                        </a>
                                                        {% if phase.status == 'pending' %}
                                                        <button class="btn btn-outline-success btn-sm"
                                                                onclick="startRelease('{{ phase.bmr.pk }}', '{{ phase.bmr.bmr_number }}')">
                                                            <i class="fas fa-play"></i> Start
                                                        </button>
                                                        {% elif phase.status == 'in_progress' %}
                                                        <button class="btn btn-outline-warning btn-sm"
                                                                onclick="completeRelease('{{ phase.bmr.pk }}', '{{ phase.bmr.bmr_number }}')">
                                                            <i class="fas fa-check"></i> Complete
                                                        </button>
                                                        {% endif %}
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="text-center py-5">
                                    <i class="fas fa-warehouse fa-3x text-success mb-3"></i>
                                    <h5 class="text-muted">No Pending Raw Material Releases</h5>
                                    <p class="text-muted">All raw material release requests are up to date.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Inventory Tab -->
                <div class="tab-pane fade" id="inventory" role="tabpanel" aria-labelledby="inventory-tab">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-boxes mr-2"></i>Raw Materials Inventory
                            </h5>
                        </div>
                        <div class="card-body">
                            <!-- Inventory Search and Filter -->
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <input type="text" id="inventorySearch" class="form-control" placeholder="Search materials...">
                                        <button class="btn btn-outline-primary" type="button" onclick="searchInventory()">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <select id="categoryFilter" class="form-select" onchange="filterInventory()">
                                        <option value="">All Categories</option>
                                        <option value="active">Active Ingredients</option>
                                        <option value="excipient">Excipients</option>
                                        <option value="packaging">Packaging Materials</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <select id="statusFilter" class="form-select" onchange="filterInventory()">
                                        <option value="">All Statuses</option>
                                        <option value="in_stock">In Stock</option>
                                        <option value="low_stock">Low Stock</option>
                                        <option value="out_of_stock">Out of Stock</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Inventory Table -->
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" id="inventoryTable">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Material Name</th>
                                            <th>Type</th>
                                            <th>In Stock</th>
                                            <th>Units</th>
                                            <th>Reorder Level</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="inventoryTableBody">
                                        <!-- Will be populated via AJAX -->
                                        <tr>
                                            <td colspan="7" class="text-center">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Add New Raw Material Tab -->
                <div class="tab-pane fade" id="add-material" role="tabpanel">
                    <div class="card mt-2">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-plus-circle me-2"></i>Add New Raw Material
                            </h5>
                        </div>
                        <div class="card-body">
                            <form id="newMaterialForm" method="post">
                                {% csrf_token %}
                                <input type="hidden" name="form_type" value="new_material">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Material Name</label>
                                        <input type="text" name="material_name" class="form-control" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Material Type</label>
                                        <select name="material_type" class="form-select" required>
                                            <option value="">Select Type</option>
                                            <option value="active">Active Ingredient</option>
                                            <option value="excipient">Excipient</option>
                                            <option value="packaging">Packaging Material</option>
                                            <option value="other">Other</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <label class="form-label">Unit of Measure</label>
                                        <select name="unit_of_measure" class="form-select" required>
                                            <option value="">Select Unit</option>
                                            <option value="kg">Kilograms (kg)</option>
                                            <option value="g">Grams (g)</option>
                                            <option value="l">Liters (L)</option>
                                            <option value="ml">Milliliters (mL)</option>
                                            <option value="pcs">Pieces (pcs)</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Initial Quantity</label>
                                        <input type="number" name="initial_quantity" class="form-control" min="0" step="0.01" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Reorder Level</label>
                                        <input type="number" name="reorder_level" class="form-control" min="0" step="0.01" required>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-12">
                                        <label class="form-label">Product Association</label>
                                        <div class="border rounded p-3">
                                            <p class="text-muted small mb-2">Select products that use this raw material:</p>
                                            <select id="associated_products" name="associated_products" class="form-select" multiple required>
                                                <!-- Will be populated via AJAX -->
                                            </select>
                                            <small class="text-muted">Hold Ctrl (Windows) or Command (Mac) to select multiple products.</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-12">
                                        <label class="form-label">Supplier Information</label>
                                        <textarea name="supplier_info" class="form-control" rows="2"></textarea>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-12">
                                        <label class="form-label">Additional Notes</label>
                                        <textarea name="notes" class="form-control" rows="2"></textarea>
                                    </div>
                                </div>
                                
                                <div class="text-end">
                                    <button type="reset" class="btn btn-outline-secondary">
                                        <i class="fas fa-undo me-2"></i>Reset
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-2"></i>Save New Material
                                    </button>
                                </div>
                            </form>
                            
                            <div id="newMaterialSuccess" class="alert alert-success mt-3 d-none">
                                <i class="fas fa-check-circle me-2"></i>Raw material added successfully!
                                <button class="btn btn-sm btn-outline-success float-end" onclick="resetNewMaterialForm()">
                                    <i class="fas fa-plus me-1"></i>Add Another Raw Material
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Receive Raw Material Batch Tab -->
                <div class="tab-pane fade" id="receive-batch" role="tabpanel">
                    <div class="card mt-2">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-truck-loading me-2"></i>Receive Raw Material Batch
                            </h5>
                        </div>
                        <div class="card-body">
                            <form id="receiveMaterialForm" method="post">
                                {% csrf_token %}
                                <input type="hidden" name="form_type" value="receive_material">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Select Raw Material</label>
                                        <select name="material_id" class="form-select" required id="material_selector">
                                            <option value="">Select Material</option>
                                            <!-- Will be populated via AJAX -->
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Batch Number</label>
                                        <input type="text" name="batch_number" class="form-control" placeholder="Supplier's batch number" required>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <label class="form-label">Received Quantity</label>
                                        <input type="number" name="received_quantity" class="form-control" min="0.01" step="0.01" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Unit of Measure</label>
                                        <input type="text" id="unit_display" class="form-control" readonly>
                                        <input type="hidden" name="unit_of_measure" id="unit_hidden">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Delivery Date</label>
                                        <input type="date" name="delivery_date" class="form-control" value="{{ today|date:'Y-m-d' }}" required>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Manufacturing Date</label>
                                        <input type="date" name="manufacturing_date" class="form-control" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Expiry Date</label>
                                        <input type="date" name="expiry_date" class="form-control" required>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-12">
                                        <label class="form-label">Supplier Information</label>
                                        <textarea name="supplier_info" class="form-control" rows="2" id="supplier_info_display" readonly></textarea>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-12">
                                        <label class="form-label">Receiving Notes</label>
                                        <textarea name="receiving_notes" class="form-control" rows="2"></textarea>
                                    </div>
                                </div>
                                
                                <div class="text-end">
                                    <button type="reset" class="btn btn-outline-secondary">
                                        <i class="fas fa-undo me-2"></i>Reset
                                    </button>
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-truck-loading me-2"></i>Record Received Batch
                                    </button>
                                </div>
                            </form>
                            
                            <div id="receiveMaterialSuccess" class="alert alert-success mt-3 d-none">
                                <i class="fas fa-check-circle me-2"></i>Raw material batch received successfully!
                                <button class="btn btn-sm btn-outline-success float-end" onclick="resetReceiveMaterialForm()">
                                    <i class="fas fa-plus me-1"></i>Receive Another Batch
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Expiry Tracking Tab -->
                <div class="tab-pane fade" id="expiry" role="tabpanel">
                    <div class="card">
                        <div class="card-header bg-danger text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-calendar-times me-2"></i>Expiry Tracking
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" id="expiryTable">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Material</th>
                                            <th>Batch Number</th>
                                            <th>Quantity Left</th>
                                            <th>Expiry Date</th>
                                            <th>Days Left</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="expiryTableBody">
                                        <!-- Will be populated via AJAX -->
                                        <tr>
                                            <td colspan="6" class="text-center">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Activity Tab -->
                <div class="tab-pane fade" id="history" role="tabpanel">
                    <div class="card">
                        <div class="card-header bg-secondary text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-history me-2"></i>Recent Activity
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Date</th>
                                            <th>Action</th>
                                            <th>Material</th>
                                            <th>Batch</th>
                                            <th>Quantity</th>
                                            <th>User</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for action in recent_activity %}
                                        <tr>
                                            <td>{{ action.timestamp|date:"M d, H:i" }}</td>
                                            <td>
                                                {% if action.action_type == 'receive' %}
                                                    <span class="badge bg-success">Received</span>
                                                {% elif action.action_type == 'issue' %}
                                                    <span class="badge bg-warning">Issued</span>
                                                {% elif action.action_type == 'add' %}
                                                    <span class="badge bg-primary">Added</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">{{ action.action_type|title }}</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ action.material.material_name }}</td>
                                            <td>
                                                {% if action.batch_number %}
                                                    {{ action.batch_number }}
                                                {% else %}
                                                    <span class="text-muted">N/A</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if action.action_type == 'receive' %}
                                                    <span class="text-success">+{{ action.quantity }} {{ action.material.unit_of_measure }}</span>
                                                {% elif action.action_type == 'issue' %}
                                                    <span class="text-danger">-{{ action.quantity }} {{ action.material.unit_of_measure }}</span>
                                                {% else %}
                                                    {{ action.quantity }} {{ action.material.unit_of_measure }}
                                                {% endif %}
                                            </td>
                                            <td>{{ action.user.username }}</td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="6" class="text-center text-muted py-3">No recent activity recorded</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Initialize tabs
    $('#sidebar-tabs a').on('click', function (e) {
        e.preventDefault();
        $(this).tab('show');
    });
    
    // Activate first tab
    $('#raw-material-release-tab').tab('show');
    
    // Load data for tabs when they are shown
    $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
        var target = $(e.target).attr("href");
        
        if (target == '#inventory') {
            console.log('Loading inventory data...');
            // loadInventoryData();
        } else if (target == '#materials') {
            console.log('Loading materials data...');
            // loadMaterialsData();
        }
    });
    
    // Form submission for new material
    $('#addRawMaterialForm').submit(function(e) {
            e.preventDefault();
            $.ajax({
                type: 'POST',
                url: '{% url "raw_materials:add_material" %}',
                data: $(this).serialize(),
                success: function(response) {
                    if(response.status === 'success') {
                        $('#newMaterialSuccess').removeClass('d-none');
                        loadInventoryData(); // Refresh inventory
                        loadMaterialsList(); // Refresh materials dropdown
                    } else {
                        alert('Error: ' + response.message);
                    }
                }
            });
        });
        
        // Form submission for receiving material
        $('#receiveMaterialForm').submit(function(e) {
            e.preventDefault();
            $.ajax({
                type: 'POST',
                url: '{% url "raw_materials:api_activity" %}',
                data: $(this).serialize(),
                success: function(response) {
                    if(response.status === 'success') {
                        $('#receiveMaterialSuccess').removeClass('d-none');
                        loadInventoryData(); // Refresh inventory
                        loadExpiryData();   // Refresh expiry data
                    } else {
                        alert('Error: ' + response.message);
                    }
                }
            });
        });
        
        // Material selector change event
        $('#material_selector').change(function() {
            var materialId = $(this).val();
            if(materialId) {
                $.ajax({
                    type: 'GET',
                    url: '{% url "raw_materials:api_batch_detail" %}',
                    data: {
                        'material_id': materialId
                    },
                    success: function(data) {
                        $('#unit_display').val(data.unit_of_measure);
                        $('#unit_hidden').val(data.unit_of_measure);
                        $('#supplier_info_display').val(data.supplier_info || 'No supplier information available');
                    }
                });
            } else {
                $('#unit_display').val('');
                $('#unit_hidden').val('');
                $('#supplier_info_display').val('');
            }
        });
    });
    
    // Load inventory data via AJAX
    function loadInventoryData() {
        $.ajax({
            type: 'GET',
            url: '{% url "raw_materials:api_materials" %}',
            success: function(data) {
                populateInventoryTable(data.materials);
            }
        });
    }
    
    // Populate inventory table with data
    function populateInventoryTable(materials) {
        var tableBody = $('#inventoryTableBody');
        tableBody.empty();
        
        if (materials && materials.length > 0) {
            materials.forEach(function(material) {
                var statusClass = material.status === 'in_stock' ? 'bg-success' : 
                                 (material.status === 'low_stock' ? 'bg-warning' : 'bg-danger');
                var statusText = material.status === 'in_stock' ? 'In Stock' : 
                               (material.status === 'low_stock' ? 'Low Stock' : 'Out of Stock');
                
                tableBody.append(`
                    <tr>
                        <td>${material.material_name}</td>
                        <td>${material.material_type_display}</td>
                        <td>${material.quantity}</td>
                        <td>${material.unit_of_measure}</td>
                        <td>${material.reorder_level}</td>
                        <td><span class="badge ${statusClass}">${statusText}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-info" onclick="viewMaterialDetails(${material.id})">
                                <i class="fas fa-info-circle"></i>
                            </button>
                        </td>
                    </tr>
                `);
            });
        } else {
            tableBody.append(`
                <tr>
                    <td colspan="7" class="text-center text-muted py-3">No materials found</td>
                </tr>
            `);
        }
    }
    
    // Search inventory
    function searchInventory() {
        var searchTerm = $('#inventorySearch').val().toLowerCase();
        var categoryFilter = $('#categoryFilter').val();
        var statusFilter = $('#statusFilter').val();
        
        $('#inventoryTable tbody tr').each(function() {
            var row = $(this);
            var materialName = row.find('td:first').text().toLowerCase();
            var materialType = row.find('td:nth-child(2)').text().toLowerCase();
            var materialStatus = row.find('td:nth-child(6)').text().toLowerCase();
            
            var nameMatch = materialName.indexOf(searchTerm) > -1;
            var categoryMatch = categoryFilter === '' || materialType.indexOf(categoryFilter) > -1;
            var statusMatch = statusFilter === '' || materialStatus.indexOf(statusFilter.replace('_', ' ')) > -1;
            
            if (nameMatch && categoryMatch && statusMatch) {
                row.show();
            } else {
                row.hide();
            }
        });
    }
    
    // Filter inventory
    function filterInventory() {
        searchInventory();
    }
    
    // Load expiry tracking data
    function loadExpiryData() {
        $.ajax({
            type: 'GET',
            url: '{% url "raw_materials:api_expiry" %}',
            success: function(data) {
                var tableBody = $('#expiryTableBody');
                tableBody.empty();
                
                if (data.batches && data.batches.length > 0) {
                    data.batches.forEach(function(batch) {
                        var statusClass = batch.days_left > 90 ? 'bg-success' : 
                                         (batch.days_left > 30 ? 'bg-warning' : 'bg-danger');
                        var statusText = batch.days_left > 90 ? 'OK' : 
                                       (batch.days_left > 30 ? 'Expiring Soon' : 'Critical');
                        
                        tableBody.append(`
                            <tr>
                                <td>${batch.material_name}</td>
                                <td>${batch.batch_number}</td>
                                <td>${batch.quantity_left} ${batch.unit_of_measure}</td>
                                <td>${batch.expiry_date}</td>
                                <td>${batch.days_left}</td>
                                <td><span class="badge ${statusClass}">${statusText}</span></td>
                            </tr>
                        `);
                    });
                } else {
                    tableBody.append(`
                        <tr>
                            <td colspan="6" class="text-center text-muted py-3">No batches found</td>
                        </tr>
                    `);
                }
            }
        });
    }
    
    // Load materials for dropdown
    function loadMaterialsList() {
        $.ajax({
            type: 'GET',
            url: '{% url "raw_materials:api_materials" %}',
            success: function(data) {
                var selector = $('#material_selector');
                selector.find('option:not(:first)').remove();
                
                if (data.materials && data.materials.length > 0) {
                    data.materials.forEach(function(material) {
                        selector.append(`
                            <option value="${material.id}">${material.material_name} (${material.material_type_display})</option>
                        `);
                    });
                }
            }
        });
    }
    
    // Load products for multi-select
    function loadProductsList() {
        $.ajax({
            type: 'GET',
            url: '{% url "products:ajax_products_list" %}',
            success: function(data) {
                var selector = $('#associated_products');
                selector.empty();
                
                if (data.products && data.products.length > 0) {
                    data.products.forEach(function(product) {
                        selector.append(`
                            <option value="${product.id}">${product.product_name} (${product.category})</option>
                        `);
                    });
                } else {
                    selector.append(`
                        <option value="" disabled>No products available</option>
                    `);
                }
            }
        });
    }
    
    // Start a material release
    function startRelease(bmrId, bmrNumber) {
        if(confirm(`Start raw material release for BMR #${bmrNumber}?`)) {
            $.ajax({
                type: 'POST',
                url: '{% url "raw_materials:api_activity" %}',
                data: {
                    'action': 'start',
                    'bmr_id': bmrId,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function(response) {
                    if(response.status === 'success') {
                        location.reload();
                    } else {
                        alert('Error: ' + response.message);
                    }
                }
            });
        }
    }
    
    // Complete a material release
    function completeRelease(bmrId, bmrNumber) {
        if(confirm(`Complete raw material release for BMR #${bmrNumber}?`)) {
            $.ajax({
                type: 'POST',
                url: '{% url "raw_materials:api_activity" %}',
                data: {
                    'action': 'complete',
                    'bmr_id': bmrId,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function(response) {
                    if(response.status === 'success') {
                        location.reload();
                    } else {
                        alert('Error: ' + response.message);
                    }
                }
            });
        }
    }
    
    // Reset new material form after successful submission
    function resetNewMaterialForm() {
        $('#newMaterialForm')[0].reset();
        $('#newMaterialSuccess').addClass('d-none');
    }
    
    // Reset receive material form after successful submission
    function resetReceiveMaterialForm() {
        $('#receiveMaterialForm')[0].reset();
        $('#receiveMaterialSuccess').addClass('d-none');
    }
    
    // View material details modal
    function viewMaterialDetails(materialId) {
        // Implementation for material details modal
        alert('Material details functionality will be implemented soon.');
    }
</script>
{% endblock %}
