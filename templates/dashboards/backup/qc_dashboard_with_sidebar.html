{% extends 'base.html' %}

{% block title %}Quality Control Dashboard - Kampala Pharmaceutical Industries{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="text-primary mb-0">
                        <i class="fas fa-microscope me-2"></i>Quality Control Dashboard
                    </h2>
                    <p class="text-muted mb-0">Product Testing & Quality Verification</p>
                </div>
                <div class="text-end">
                    <small class="text-muted">Welcome, {{ user.get_full_name|default:user.username }}</small><br>
                    <small class="text-success">{{ user.get_role_display }}</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title mb-0">{{ stats.pending_tests }}</h5>
                            <p class="card-text">Pending Tests</p>
                        </div>
                        <i class="fas fa-clock fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title mb-0">{{ stats.in_testing }}</h5>
                            <p class="card-text">In Testing</p>
                        </div>
                        <i class="fas fa-vial fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title mb-0">{{ stats.passed_today }}</h5>
                            <p class="card-text">Passed Today</p>
                        </div>
                        <i class="fas fa-check-circle fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title mb-0">{{ stats.failed_this_week }}</h5>
                            <p class="card-text">Failed This Week</p>
                        </div>
                        <i class="fas fa-times-circle fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <!-- Sidebar Navigation -->
        <div class="col-lg-3 col-md-4 mb-4">
            <div class="sidebar">
                <div class="list-group list-group-flush">
                    <h5 class="px-3 py-2 mb-0 border-bottom bg-light">QC Navigation</h5>
                    
                    <a href="#" class="nav-link active" id="pending-tests-link" data-bs-toggle="tab" data-bs-target="#pending-tests">
                        <i class="fas fa-flask me-2"></i>Pending Tests
                    </a>
                    
                    <a href="#" class="nav-link sidebar-alert {% if stats.pending_raw_materials > 0 %}text-danger{% endif %}" id="raw-materials-link" data-bs-toggle="tab" data-bs-target="#raw-materials">
                        <i class="fas fa-boxes me-2"></i>Raw Materials QC
                        {% if stats.pending_raw_materials > 0 %}
                            <span class="badge bg-danger">{{ stats.pending_raw_materials }}</span>
                        {% endif %}
                    </a>
                    
                    <a href="#" class="nav-link" id="in-progress-link" data-bs-toggle="tab" data-bs-target="#in-progress">
                        <i class="fas fa-spinner me-2"></i>In Progress Tests
                    </a>
                    
                    <a href="#" class="nav-link" id="completed-link" data-bs-toggle="tab" data-bs-target="#completed">
                        <i class="fas fa-check-double me-2"></i>Completed Tests
                    </a>
                    
                    <a href="#" class="nav-link" id="reports-link" data-bs-toggle="tab" data-bs-target="#reports">
                        <i class="fas fa-chart-bar me-2"></i>QC Reports
                    </a>
                    
                    <a href="#" class="nav-link" id="specifications-link" data-bs-toggle="tab" data-bs-target="#specifications">
                        <i class="fas fa-clipboard-list me-2"></i>Specifications
                    </a>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-lg-9 col-md-8">
            <div class="tab-content" id="qcTabsContent">
                <!-- Pending Tests Tab -->
                <div class="tab-pane fade show active" id="pending-tests" role="tabpanel">
                    <div class="card">
                        <div class="card-header bg-warning text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-flask me-2"></i>Pending Quality Control Tests
                            </h5>
                        </div>
                        <div class="card-body">
                            {% if pending_phases %}
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>BMR Number</th>
                                                <th>Product</th>
                                                <th>Phase</th>
                                                <th>Batch Size</th>
                                                <th>Priority</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for phase in pending_phases %}
                                            <tr>
                                                <td><strong>{{ phase.bmr.bmr_number }}</strong></td>
                                                <td>{{ phase.bmr.product.product_name }}</td>
                                                <td>{{ phase.phase.get_phase_name_display }}</td>
                                                <td>{{ phase.bmr.batch_size|floatformat:0 }} {{ phase.bmr.product.unit_of_measure }}</td>
                                                <td>
                                                    {% if phase.bmr.created_date|timesince|slice:":1" == "0" %}
                                                        <span class="badge bg-danger">Urgent</span>
                                                    {% elif phase.bmr.created_date|timesince|slice:":1" == "1" %}
                                                        <span class="badge bg-warning">High</span>
                                                    {% else %}
                                                        <span class="badge bg-success">Normal</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <span class="badge bg-warning">Pending</span>
                                                </td>
                                                <td>
                                                    <button type="button" class="btn btn-sm btn-primary" onclick="startTest('{{ phase.id }}', '{{ phase.bmr.bmr_number }}')">
                                                        <i class="fas fa-play"></i> Start Test
                                                    </button>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>No pending quality control tests at the moment.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Raw Materials QC Tab -->
                <div class="tab-pane fade" id="raw-materials" role="tabpanel">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-boxes me-2"></i>Raw Materials Quality Control
                            </h5>
                        </div>
                        <div class="card-body">
                            <!-- Raw Materials Pending QC -->
                            <h5 class="mb-3">Pending Raw Material QC</h5>
                            {% if pending_raw_materials %}
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>Material</th>
                                                <th>Batch Number</th>
                                                <th>Quantity</th>
                                                <th>Supplier</th>
                                                <th>Received Date</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for batch in pending_raw_materials %}
                                            <tr>
                                                <td><strong>{{ batch.material.material_name }}</strong></td>
                                                <td>{{ batch.batch_number }}</td>
                                                <td>{{ batch.quantity }} {{ batch.material.unit_of_measure }}</td>
                                                <td>{{ batch.supplier|default:batch.material.default_supplier }}</td>
                                                <td>{{ batch.received_date|date:"M d, Y" }}</td>
                                                <td>
                                                    <button type="button" class="btn btn-sm btn-primary" onclick="startMaterialQC('{{ batch.id }}', '{{ batch.material.material_name }}')">
                                                        <i class="fas fa-vial"></i> Start QC
                                                    </button>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>No raw materials pending quality control.
                                </div>
                            {% endif %}
                            
                            <!-- In Progress Raw Material QC -->
                            <h5 class="mt-4 mb-3">In Progress Raw Material QC</h5>
                            {% if in_progress_raw_materials %}
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>Material</th>
                                                <th>Batch Number</th>
                                                <th>Started By</th>
                                                <th>Started Date</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for qc in in_progress_raw_materials %}
                                            <tr>
                                                <td><strong>{{ qc.material_batch.material.material_name }}</strong></td>
                                                <td>{{ qc.material_batch.batch_number }}</td>
                                                <td>{{ qc.started_by.get_full_name }}</td>
                                                <td>{{ qc.started_date|date:"M d, H:i" }}</td>
                                                <td>
                                                    <button type="button" class="btn btn-sm btn-success" onclick="completeMaterialQC('{{ qc.id }}', '{{ qc.material_batch.material.material_name }}')">
                                                        <i class="fas fa-check"></i> Complete QC
                                                    </button>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>No raw materials in testing process.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- In Progress Tests Tab -->
                <div class="tab-pane fade" id="in-progress" role="tabpanel">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-spinner me-2"></i>In Progress Tests
                            </h5>
                        </div>
                        <div class="card-body">
                            {% if in_progress_phases %}
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>BMR Number</th>
                                                <th>Product</th>
                                                <th>Phase</th>
                                                <th>Started By</th>
                                                <th>Started Date</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for phase in in_progress_phases %}
                                            <tr>
                                                <td><strong>{{ phase.bmr.bmr_number }}</strong></td>
                                                <td>{{ phase.bmr.product.product_name }}</td>
                                                <td>{{ phase.phase.get_phase_name_display }}</td>
                                                <td>{{ phase.started_by.get_full_name }}</td>
                                                <td>{{ phase.started_date|date:"M d, H:i" }}</td>
                                                <td>
                                                    <div class="btn-group">
                                                        <button type="button" class="btn btn-sm btn-success" onclick="completeTest('{{ phase.id }}', '{{ phase.bmr.bmr_number }}', 'approve')">
                                                            <i class="fas fa-check"></i> Pass
                                                        </button>
                                                        <button type="button" class="btn btn-sm btn-danger" onclick="completeTest('{{ phase.id }}', '{{ phase.bmr.bmr_number }}', 'reject')">
                                                            <i class="fas fa-times"></i> Fail
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>No quality control tests in progress.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Completed Tests Tab -->
                <div class="tab-pane fade" id="completed" role="tabpanel">
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-check-double me-2"></i>Completed Tests
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <input type="text" class="form-control" id="searchCompletedTests" placeholder="Search by BMR number, product, or result...">
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" id="completedTestsTable">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>BMR Number</th>
                                            <th>Product</th>
                                            <th>Phase</th>
                                            <th>Completed</th>
                                            <th>Result</th>
                                            <th>Completed By</th>
                                            <th>Details</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for phase in completed_phases %}
                                        <tr>
                                            <td><strong>{{ phase.bmr.bmr_number }}</strong></td>
                                            <td>{{ phase.bmr.product.product_name }}</td>
                                            <td>{{ phase.phase.get_phase_name_display }}</td>
                                            <td>{{ phase.completed_date|date:"M d, H:i" }}</td>
                                            <td>
                                                {% if phase.status == 'completed' %}
                                                    <span class="badge bg-success">Passed</span>
                                                {% elif phase.status == 'rejected' %}
                                                    <span class="badge bg-danger">Failed</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">{{ phase.status }}</span>
                                                {% endif %}
                                            </td>
                                            <td>{{ phase.completed_by.get_full_name }}</td>
                                            <td>
                                                <button type="button" class="btn btn-sm btn-info" onclick="viewTestDetails('{{ phase.id }}', '{{ phase.bmr.bmr_number }}')">
                                                    <i class="fas fa-file-alt"></i> View
                                                </button>
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="7" class="text-center">No completed tests in the last 30 days</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- QC Reports Tab -->
                <div class="tab-pane fade" id="reports" role="tabpanel">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-chart-bar me-2"></i>Quality Control Reports
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card mb-3">
                                        <div class="card-header bg-light">
                                            <h6 class="mb-0">Monthly Test Results</h6>
                                        </div>
                                        <div class="card-body">
                                            <canvas id="monthlyResultsChart" height="200"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card mb-3">
                                        <div class="card-header bg-light">
                                            <h6 class="mb-0">Test Categories</h6>
                                        </div>
                                        <div class="card-body">
                                            <canvas id="testCategoriesChart" height="200"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <h5 class="mt-4 mb-3">Generate QC Reports</h5>
                            <form class="row g-3">
                                <div class="col-md-4">
                                    <label for="reportType" class="form-label">Report Type</label>
                                    <select class="form-select" id="reportType">
                                        <option value="monthly">Monthly Summary</option>
                                        <option value="product">By Product</option>
                                        <option value="raw_material">Raw Material QC</option>
                                        <option value="failures">Failure Analysis</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="dateRange" class="form-label">Date Range</label>
                                    <select class="form-select" id="dateRange">
                                        <option value="7">Last 7 days</option>
                                        <option value="30" selected>Last 30 days</option>
                                        <option value="90">Last 3 months</option>
                                        <option value="180">Last 6 months</option>
                                        <option value="365">Last year</option>
                                        <option value="custom">Custom range</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="exportFormat" class="form-label">Export Format</label>
                                    <select class="form-select" id="exportFormat">
                                        <option value="excel">Excel</option>
                                        <option value="pdf">PDF</option>
                                        <option value="csv">CSV</option>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <button type="button" class="btn btn-primary" onclick="generateReport()">
                                        <i class="fas fa-file-export me-2"></i>Generate Report
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Specifications Tab -->
                <div class="tab-pane fade" id="specifications" role="tabpanel">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-clipboard-list me-2"></i>Quality Control Specifications
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <input type="text" class="form-control" id="searchSpecifications" placeholder="Search specifications...">
                            </div>
                            
                            <ul class="nav nav-tabs" id="specificationTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="raw-material-specs-tab" data-bs-toggle="tab" data-bs-target="#raw-material-specs" type="button" role="tab" aria-controls="raw-material-specs" aria-selected="true">Raw Materials</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="product-specs-tab" data-bs-toggle="tab" data-bs-target="#product-specs" type="button" role="tab" aria-controls="product-specs" aria-selected="false">Products</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="phase-specs-tab" data-bs-toggle="tab" data-bs-target="#phase-specs" type="button" role="tab" aria-controls="phase-specs" aria-selected="false">Production Phases</button>
                                </li>
                            </ul>
                            
                            <div class="tab-content pt-3" id="specificationTabsContent">
                                <div class="tab-pane fade show active" id="raw-material-specs" role="tabpanel" aria-labelledby="raw-material-specs-tab">
                                    <div class="table-responsive">
                                        <table class="table table-sm table-striped table-hover">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Material Name</th>
                                                    <th>Test</th>
                                                    <th>Specification</th>
                                                    <th>Acceptable Range</th>
                                                    <th>Units</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for spec in raw_material_specifications %}
                                                <tr>
                                                    <td>{{ spec.material.material_name }}</td>
                                                    <td>{{ spec.test_name }}</td>
                                                    <td>{{ spec.specification }}</td>
                                                    <td>{{ spec.min_value }} - {{ spec.max_value }}</td>
                                                    <td>{{ spec.units }}</td>
                                                    <td>
                                                        <button type="button" class="btn btn-sm btn-outline-primary">
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                                {% empty %}
                                                <tr>
                                                    <td colspan="6" class="text-center">No raw material specifications found</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="product-specs" role="tabpanel" aria-labelledby="product-specs-tab">
                                    <!-- Product specifications table similar to raw material specs -->
                                    <p class="text-muted">Product specification data would appear here...</p>
                                </div>
                                <div class="tab-pane fade" id="phase-specs" role="tabpanel" aria-labelledby="phase-specs-tab">
                                    <!-- Phase specifications table -->
                                    <p class="text-muted">Phase-specific QC criteria would appear here...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Test QC Functions
function startTest(phaseId, bmrNumber) {
    const notes = prompt(`Enter notes for starting QC test for BMR ${bmrNumber}:`);
    if (notes !== null) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{% url "dashboards:qc_dashboard" %}';
        
        // Add CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfToken) {
            form.appendChild(csrfToken.cloneNode());
        }
        
        // Add form data
        const fields = {
            'phase_id': phaseId,
            'action': 'start_test',
            'notes': notes
        };
        
        for (const [key, value] of Object.entries(fields)) {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = key;
            input.value = value;
            form.appendChild(input);
        }
        
        document.body.appendChild(form);
        form.submit();
    }
}

function completeTest(phaseId, bmrNumber, result) {
    const action = result === 'approve' ? 'approve' : 'reject';
    const actionText = result === 'approve' ? 'approving' : 'rejecting';
    const notes = prompt(`Enter notes for ${actionText} QC test for BMR ${bmrNumber}:`);
    
    if (notes !== null) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{% url "dashboards:qc_dashboard" %}';
        
        // Add CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfToken) {
            form.appendChild(csrfToken.cloneNode());
        }
        
        // Add form data
        const fields = {
            'phase_id': phaseId,
            'action': action,
            'notes': notes
        };
        
        for (const [key, value] of Object.entries(fields)) {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = key;
            input.value = value;
            form.appendChild(input);
        }
        
        document.body.appendChild(form);
        form.submit();
    }
}

// Raw Material QC Functions
function startMaterialQC(batchId, materialName) {
    const notes = prompt(`Enter notes for starting QC test for ${materialName}:`);
    if (notes !== null) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{% url "dashboards:qc_dashboard" %}';
        
        // Add CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfToken) {
            form.appendChild(csrfToken.cloneNode());
        }
        
        // Add form data
        const fields = {
            'batch_id': batchId,
            'action': 'start_material_qc',
            'notes': notes
        };
        
        for (const [key, value] of Object.entries(fields)) {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = key;
            input.value = value;
            form.appendChild(input);
        }
        
        document.body.appendChild(form);
        form.submit();
    }
}

function completeMaterialQC(qcId, materialName) {
    const result = confirm(`Did ${materialName} pass QC checks?`);
    const status = result ? 'approved' : 'rejected';
    const notes = prompt(`Enter notes for ${status} QC result for ${materialName}:`);
    
    if (notes !== null) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{% url "dashboards:qc_dashboard" %}';
        
        // Add CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfToken) {
            form.appendChild(csrfToken.cloneNode());
        }
        
        // Add form data
        const fields = {
            'qc_id': qcId,
            'action': 'complete_material_qc',
            'status': status,
            'notes': notes
        };
        
        for (const [key, value] of Object.entries(fields)) {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = key;
            input.value = value;
            form.appendChild(input);
        }
        
        document.body.appendChild(form);
        form.submit();
    }
}

// Additional functions
function viewTestDetails(phaseId, bmrNumber) {
    window.location.href = `{% url 'dashboards:qc_test_detail' test_id=0 %}`.replace('0', phaseId);
}

function generateReport() {
    alert('Report generation functionality coming soon!');
}

// Initialize sidebar links with tab functionality
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.sidebar .nav-link').forEach(function(link) {
        link.addEventListener('click', function(event) {
            event.preventDefault();
            
            document.querySelectorAll('.sidebar .nav-link').forEach(function(l) {
                l.classList.remove('active');
            });
            this.classList.add('active');
            
            const target = document.querySelector(this.dataset.bsTarget);
            document.querySelectorAll('.tab-pane').forEach(function(pane) {
                pane.classList.remove('show', 'active');
            });
            
            if (target) {
                target.classList.add('show', 'active');
            }
        });
    });
    
    // Search functionality for completed tests
    document.getElementById('searchCompletedTests')?.addEventListener('keyup', function() {
        const searchValue = this.value.toLowerCase();
        const tableRows = document.querySelectorAll('#completedTestsTable tbody tr');
        
        tableRows.forEach(function(row) {
            const bmrNumber = row.querySelector('td:nth-child(1)').textContent.toLowerCase();
            const productName = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
            const result = row.querySelector('td:nth-child(5)').textContent.toLowerCase();
            
            if (bmrNumber.includes(searchValue) || productName.includes(searchValue) || result.includes(searchValue)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });
    
    // Search functionality for specifications
    document.getElementById('searchSpecifications')?.addEventListener('keyup', function() {
        const searchValue = this.value.toLowerCase();
        const tableRows = document.querySelectorAll('#specificationTabsContent tbody tr');
        
        tableRows.forEach(function(row) {
            const materialName = row.querySelector('td:nth-child(1)')?.textContent.toLowerCase();
            const testName = row.querySelector('td:nth-child(2)')?.textContent.toLowerCase();
            
            if ((materialName && materialName.includes(searchValue)) || 
                (testName && testName.includes(searchValue))) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });

    // Initialize any charts
    if (document.getElementById('monthlyResultsChart')) {
        new Chart(document.getElementById('monthlyResultsChart'), {
            type: 'line',
            data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                datasets: [{
                    label: 'Passed',
                    data: [65, 59, 80, 81, 56, 55],
                    backgroundColor: 'rgba(40, 167, 69, 0.2)',
                    borderColor: 'rgba(40, 167, 69, 1)',
                    borderWidth: 2
                }, {
                    label: 'Failed',
                    data: [12, 19, 3, 5, 2, 3],
                    backgroundColor: 'rgba(220, 53, 69, 0.2)',
                    borderColor: 'rgba(220, 53, 69, 1)',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }
    
    if (document.getElementById('testCategoriesChart')) {
        new Chart(document.getElementById('testCategoriesChart'), {
            type: 'doughnut',
            data: {
                labels: ['Raw Materials', 'In-Process', 'Finished Goods'],
                datasets: [{
                    data: [45, 30, 25],
                    backgroundColor: [
                        'rgba(0, 123, 255, 0.8)',
                        'rgba(40, 167, 69, 0.8)',
                        'rgba(255, 193, 7, 0.8)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }
});
</script>

<!-- CSRF Token for AJAX requests -->
{% csrf_token %}
{% endblock %}
